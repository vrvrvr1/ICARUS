<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Logs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .meta-cell { max-width: 680px; white-space: normal; overflow: hidden; }
    .meta-list { display: grid; grid-template-columns: 1fr; gap: 2px; }
    .meta-list .meta-key { font-weight: 600; color: var(--text-secondary); margin-right: 6px; }
    .meta-raw { margin-top: 6px; }
    .meta-raw pre { margin: 6px 0 0 0; background: #0b1620; color: #e5e7eb; padding: 8px; border-radius: 6px; max-height: 220px; overflow: auto; white-space: pre-wrap; word-break: break-word; }
    .time-cell { white-space: nowrap; }
  </style>
</head>
<body>
  <aside class="dashboard-sidebar">
    <div>
      <div class="sidebar-profile">
        <img src="/images/avatar.jpg" alt="Admin" class="sidebar-avatar" />
        <div>
          <div class="sidebar-welcome">Welcome back,</div>
          <div class="sidebar-name">Admin</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders"><i class="bi bi-bag-check"></i> Orders</a>
        <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
        <a href="/admin/announcements"><i class="bi bi-megaphone"></i> Announcements</a>
        <a href="/admin/audit-logs" class="active"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
      </nav>
    </div>

    <div>
      <p class="text-center text-secondary small mb-0">Â© 2025 Icarus Wears</p>
    </div>
  </aside>

  <main class="dashboard-main">
    <div class="dashboard-header">
      <div>
        <div class="dashboard-title-main">Audit Logs</div>
        <div class="dashboard-title-sub">Recent admin actions and system events</div>
      </div>
    </div>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0">Recent Activity</h3>
        <div>
          <button class="btn" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>
      </div>

      <!-- Compact filter bar (search, range, action, limit, apply) -->
      <% const f = (typeof filters !== 'undefined' && filters) ? filters : { action:'', q:'', range:'', limit:'' }; %>
      <form method="get" action="/admin/audit-logs" style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
  <input name="q" value="<%= f.q %>" placeholder="Search by name, action, resource..." style="padding:8px 10px;border-radius:8px;border:1px solid #ddd;min-width:320px;flex:1;" />

        <select name="range" style="padding:8px;border-radius:8px;border:1px solid #ddd;">
          <option value="30" <%= f.range==='30' ? 'selected':'' %>>Last 30 days</option>
          <option value="7" <%= f.range==='7' ? 'selected':'' %>>Last 7 days</option>
          <option value="90" <%= f.range==='90' ? 'selected':'' %>>Last 90 days</option>
          <option value="all" <%= (!f.range || f.range==='all') ? 'selected':'' %>>All time</option>
        </select>

        <select name="action" style="padding:8px;border-radius:8px;border:1px solid #ddd;min-width:170px;">
          <option value="" <%= !f.action ? 'selected' : '' %>>All Actions</option>
          <option value="cart.add" <%= f.action==='cart.add'? 'selected':'' %>>Added to cart</option>
          <option value="cart.remove" <%= f.action==='cart.remove'? 'selected':'' %>>Removed from cart</option>
          <option value="order.place" <%= f.action==='order.place'? 'selected':'' %>>Placed order</option>
          <option value="order.checkout" <%= f.action==='order.checkout'? 'selected':'' %>>Checkout</option>
          <option value="wishlist.add" <%= f.action==='wishlist.add'? 'selected':'' %>>Wishlist add</option>
        </select>

        <select name="limit" style="padding:8px;border-radius:8px;border:1px solid #ddd;min-width:90px;">
          <option value="10" <%= f.limit==='10'? 'selected':'' %>>10</option>
          <option value="25" <%= f.limit==='25'? 'selected':'' %>>25</option>
          <option value="50" <%= f.limit==='50'? 'selected':'' %>>50</option>
          <option value="100" <%= f.limit==='100'? 'selected':'' %>>100</option>
        </select>

  <button class="btn btn-primary" type="submit" style="display:inline-flex;align-items:center;justify-content:center;width:92px;height:36px;border-radius:8px;box-sizing:border-box;">Apply</button>
  <a class="btn btn-outline" href="/admin/audit-logs" role="button" style="display:inline-flex;align-items:center;justify-content:center;width:92px;height:36px;border-radius:8px;box-sizing:border-box;">Reset</a>
      </form>

      <div class="table-responsive">
        <table class="orders-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Action</th>
              <th>Meta</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <% if (!items || !items.length) { %>
              <tr><td colspan="4" style="text-align:center;">No audit logs yet.</td></tr>
            <% } else { %>
              <% items.forEach(row => { %>
                <tr>
                  <td><%= row.user_name || ('User #' + (row.user_id || 'N/A')) %></td>
                  <td>
                    <% 
                      // friendly action examples
                      const _action = String(row.action || '');
                      const _actionMap = {
                        'cart.add': { label: 'Added to cart', icon: 'bi-cart-plus' },
                        'cart.remove': { label: 'Removed from cart', icon: 'bi-cart-dash' },
                        'order.place': { label: 'Placed order', icon: 'bi-bag-check' },
                        'order.checkout': { label: 'Checkout / Placed order', icon: 'bi-credit-card' },
                        'wishlist.add': { label: 'Added to wishlist', icon: 'bi-heart' },
                        'wishlist.remove': { label: 'Removed from wishlist', icon: 'bi-heartbreak' }
                      };
                      const mapped = _actionMap[_action];
                    %>
                    <% if (mapped) { %>
                      <div style="display:flex;align-items:center;gap:8px;">
                        <i class="bi <%= mapped.icon %>" aria-hidden="true"></i>
                        <div>
                          <div style="font-weight:700"><%= mapped.label %></div>
                          <div style="font-size:12px;color:#6b7280"><code><%= _action %></code></div>
                        </div>
                      </div>
                    <% } else { %>
                      <code><%= row.action %></code>
                    <% } %>
                  </td>
                  <td class="meta-cell">
                    <% let _meta = row.meta; try { if (typeof _meta === 'string') { _meta = JSON.parse(_meta); } } catch(e){} %>
                    <% if (_meta && typeof _meta === 'object') { %>
                      <% const _keys = Object.keys(_meta); const _known = ['method','email','ip','ua']; %>
                      <div class="meta-list">
                        <% if (_meta.method) { %>
                          <div><span class="meta-key">Method:</span> <span class="meta-value"><%= _meta.method %></span></div>
                        <% } %>
                        <% if (_meta.email) { %>
                          <div><span class="meta-key">Email:</span> <span class="meta-value"><%= _meta.email %></span></div>
                        <% } %>
                        <% if (_meta.ip) { %>
                          <div><span class="meta-key">IP:</span> <span class="meta-value"><%= _meta.ip %></span></div>
                        <% } %>
                        <% if (_meta.ua) { %>
                          <div><span class="meta-key">UA:</span> <span class="meta-value"><%= _meta.ua %></span></div>
                        <% } %>
                        <% _keys.filter(k => !_known.includes(k)).forEach(k => { %>
                          <div><span class="meta-key"><%= k %>:</span> <span class="meta-value"><%= String(_meta[k]) %></span></div>
                        <% }) %>
                      </div>
                      <details class="meta-raw"><summary>Raw</summary><pre><%= JSON.stringify(_meta, null, 2) %></pre></details>
                    <% } else { %>
                      <code><%= row.meta ? (typeof row.meta === 'string' ? row.meta : JSON.stringify(row.meta)) : '' %></code>
                    <% } %>
                  </td>
                  <td class="time-cell"><%= row.created_at ? new Date(row.created_at).toLocaleString() : '' %></td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</body>
</html>
