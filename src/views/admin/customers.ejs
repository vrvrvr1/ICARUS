<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <aside class="dashboard-sidebar">
    <div>
      <div class="sidebar-profile">
        <img src="/images/avatar.jpg" alt="Admin" class="sidebar-avatar" />
        <div>
          <div class="sidebar-welcome">Welcome back,</div>
          <div class="sidebar-name">Admin</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers" class="active"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders"><i class="bi bi-bag-check"></i> Orders</a>
        <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
        <a href="/admin/audit-logs"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        <a href="/admin/cms"><i class="bi bi-journal-text"></i> CMS</a>
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
      </nav>
    </div>

    <div>
      <p class="text-center text-secondary small mb-0">© 2025 Icarus Wears</p>
    </div>
  </aside>

  <main class="dashboard-main">
    <div class="dashboard-header">
      <div>
        <div class="dashboard-title-main">Customers</div>
        <div class="dashboard-title-sub">Manage your store customers</div>
      </div>
      <div class="dashboard-search">
        <a href="/admin" class="btn btn-ghost">← Back to Dashboard</a>
      </div>
    </div>

    <div class="dashboard-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h3 style="margin:0">All Customers</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn" id="addCustomerBtn"><i class="bi bi-plus-circle me-2"></i>Add Customer</button>
          <select class="filter">
            <option>This Month</option>
            <option>Last Month</option>
            <option>All Time</option>
          </select>
          <button class="btn btn-ghost" onclick="location.reload()">Refresh</button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Email</th>
                <th>Role</th>
                <th>Total Orders</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
            <% if (!customers || customers.length === 0) { %>
              <tr>
                <td colspan="5">No customers found.</td>
              </tr>
            <% } else { %>
              <% customers.forEach(customer => { %>
                <% 
                  // normalize the stored profile image and compute a public href
                  let rawImg = customer.profile_image || null;
                  let imgHref = '/image/profile1.png';
                  if (rawImg) {
                    rawImg = String(rawImg).trim();
                    rawImg = rawImg.replace(/\\/g, '/');
                    if (rawImg.startsWith('./')) rawImg = rawImg.slice(2);
                    if (rawImg.toLowerCase().startsWith('uploads/')) rawImg = rawImg.slice(8);
                    if (/^https?:\/\//i.test(rawImg) || rawImg.startsWith('/')) imgHref = rawImg;
                    else imgHref = '/uploads/' + rawImg;
                  }
                %>
                <tr>
                  <td>
                    <div class="customer-cell">
                      <button class="avatar-btn" data-img="<%= imgHref %>">
                        <img src="<%= imgHref %>" alt="customer avatar" class="order-thumb" onerror="this.src='/image/profile1.png'" />
                      </button>
                    </div>
                  </td>
                  <td><%= customer.email %></td>
                  <td><%= customer.role %></td>
                  <td><%= customer.total_orders || 0 %></td>
                  <td style="text-align:right;">
                    <a href="/customers/<%= customer.id %>" class="btn-action" title="View"><i class="bi bi-eye-fill"></i></a>
                    <a href="/customers/<%= customer.id %>/edit" class="btn-action" title="Edit"><i class="bi bi-pencil-fill"></i></a>
                    <form action="/customers/<%= customer.id %>/delete" method="POST" style="display:inline;" class="delete-customer-form">
                      <button type="button" class="btn-action btn-delete-customer" data-customer-id="<%= customer.id %>" data-customer-email="<%= customer.email %>" title="Delete"><i class="bi bi-trash3-fill"></i></button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</main>

  <!-- Add Customer Modal -->
  <div id="addCustomerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:10000;overflow-y:auto;">
    <div style="background:#ffffff;color:#222222;padding:32px;border-radius:12px;max-width:500px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.2);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;font-size:1.3rem;">Add New Customer</h3>
        <button id="addCustomerModalClose" style="background:transparent;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
      </div>
      
      <form id="addCustomerForm" method="POST" action="/customers/add" style="display:flex;flex-direction:column;gap:16px;">
        <div>
          <label for="new_email" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Email <span style="color:#ef4444;">*</span></label>
          <input type="email" id="new_email" name="email" required placeholder="customer@example.com" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;" />
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <label for="new_first_name" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">First Name <span style="color:#ef4444;">*</span></label>
            <input type="text" id="new_first_name" name="first_name" required placeholder="John" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;" />
          </div>
          <div>
            <label for="new_last_name" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Last Name <span style="color:#ef4444;">*</span></label>
            <input type="text" id="new_last_name" name="last_name" required placeholder="Doe" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;" />
          </div>
        </div>

        <div>
          <label for="new_password" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Password <span style="color:#ef4444;">*</span></label>
          <input type="password" id="new_password" name="password" required placeholder="Minimum 6 characters" minlength="6" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;" />
          <small style="color:#6b7280;display:block;margin-top:4px;">Minimum 6 characters</small>
        </div>

        <div>
          <label for="new_role" style="display:block;margin-bottom:6px;font-weight:500;font-size:14px;">Role</label>
          <select id="new_role" name="role" style="width:100%;padding:10px 14px;border:1px solid #ddd;border-radius:8px;font-size:15px;">
            <option value="customer">Customer</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <div style="display:flex;gap:12px;margin-top:8px;">
          <button type="submit" class="btn" style="flex:1;padding:10px 20px;"><i class="bi bi-check-circle me-2"></i>Create Customer</button>
          <button type="button" id="addCustomerFormCancel" class="btn btn-ghost" style="padding:10px 20px;">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image preview modal -->
  <!-- Delete customer confirmation modal -->
  <style>
  /* Modal color fixes specific to delete confirmation to ensure contrast */
    #deleteCustomerModal .modal-card {
      background: #ffffff;
      color: #222222;
      padding: 24px 32px;
      border-radius: 10px;
      max-width: 95vw;
      min-width: 320px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }
    #deleteCustomerModal .modal-title { font-size:1.15rem; font-weight:600; text-align:center; }
    #deleteCustomerModal #deleteCustomerEmail { color:#555555; font-size:0.98rem; }
    #deleteCustomerModal .btn-ghost {
      background: #ffffff !important;
      border: 1px solid #e6e6e6 !important;
      color: #222222 !important;
      padding: 8px 14px !important;
      border-radius: 8px !important;
      min-width: 90px !important;
      font-size: 14px !important;
      line-height: 1.1 !important;
    }
    #deleteCustomerModal .btn-danger {
      background: #d32f2f !important; /* red (danger) */
      color: #ffffff !important;
      padding: 8px 14px !important;
      border-radius: 8px !important;
      border: none !important;
      min-width: 90px !important;
      font-weight: 600 !important;
      font-size: 14px !important;
    }
    /* Dark-mode support (if your app supports it) */
    @media (prefers-color-scheme: dark) {
      #deleteCustomerModal .modal-card { background: #0f1720; color: #e6eef8; }
  #deleteCustomerModal .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: #e6eef8; }
  #deleteCustomerModal .btn-danger { background: #ff5252; color: #0b1220; }
    }
  </style>

  <div id="deleteCustomerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:10000;">
    <div class="modal-card">
      <div class="modal-title">Are you sure you want to delete this customer?</div>
      <div id="deleteCustomerEmail"></div>
      <div style="display:flex;gap:16px;margin-top:8px;">
        <button id="deleteCustomerCancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="deleteCustomerConfirm" class="btn btn-danger" type="button">Delete</button>
      </div>
    </div>
  </div>
  <!-- Success modal (transient) -->
  <style>
    #deleteSuccessModal .success-card { background: #eaf6ea; color: #1b421b; padding: 14px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    #deleteSuccessModal .success-title { font-weight:600; }
    @media (prefers-color-scheme: dark) {
      #deleteSuccessModal .success-card { background: #123116; color: #cfe6cf; }
    }
  </style>
  <div id="deleteSuccessModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:11000;pointer-events:none;">
    <div style="pointer-events:auto;">
      <div class="success-card" style="min-width:220px; text-align:center;">
        <div class="success-title">Customer deleted</div>
      </div>
    </div>
  </div>
  <div id="avatarModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:9999;">
    <div style="background:#fff;padding:12px;border-radius:8px;max-width:90%;max-height:90%;display:flex;flex-direction:column;gap:8px;align-items:center;">
      <button id="avatarModalClose" style="position:absolute;right:16px;top:16px;background:transparent;border:none;font-size:18px;cursor:pointer;">&times;</button>
      <img id="avatarModalImg" src="" alt="Avatar preview" style="max-width:100%;max-height:80vh;border-radius:6px;" />
      <div style="width:100%;display:flex;justify-content:center;gap:8px;">
        <a id="avatarModalOpen" href="#" target="_blank" class="btn btn-ghost">Open image in new tab</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Add Customer Modal
      const addCustomerBtn = document.getElementById('addCustomerBtn');
      const addCustomerModal = document.getElementById('addCustomerModal');
      const addCustomerModalClose = document.getElementById('addCustomerModalClose');
      const addCustomerFormCancel = document.getElementById('addCustomerFormCancel');

      if (addCustomerBtn) {
        addCustomerBtn.addEventListener('click', function() {
          addCustomerModal.style.display = 'flex';
        });
      }

      if (addCustomerModalClose) {
        addCustomerModalClose.addEventListener('click', function() {
          addCustomerModal.style.display = 'none';
        });
      }

      if (addCustomerFormCancel) {
        addCustomerFormCancel.addEventListener('click', function() {
          addCustomerModal.style.display = 'none';
        });
      }

      // Close modal on outside click
      addCustomerModal.addEventListener('click', function(e) {
        if (e.target === addCustomerModal) {
          addCustomerModal.style.display = 'none';
        }
      });

      // Avatar preview
      document.querySelectorAll('.avatar-btn').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.preventDefault();
          const img = btn.getAttribute('data-img');
          if (!img) return;
          const modal = document.getElementById('avatarModal');
          const modalImg = document.getElementById('avatarModalImg');
          const openLink = document.getElementById('avatarModalOpen');
          modalImg.src = img;
          openLink.href = img;
          modal.style.display = 'flex';
        });
      });
      const closeBtn = document.getElementById('avatarModalClose');
      if (closeBtn) closeBtn.addEventListener('click', function(){ document.getElementById('avatarModal').style.display='none'; });

      // Delete customer modal logic
      let deleteTargetForm = null;
      document.querySelectorAll('.btn-delete-customer').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.preventDefault();
          deleteTargetForm = btn.closest('form');
          const email = btn.getAttribute('data-customer-email') || '';
          document.getElementById('deleteCustomerEmail').textContent = email;
          document.getElementById('deleteCustomerModal').style.display = 'flex';
        });
      });
      document.getElementById('deleteCustomerCancel').onclick = function(){
        document.getElementById('deleteCustomerModal').style.display = 'none';
        deleteTargetForm = null;
      };
      document.getElementById('deleteCustomerConfirm').onclick = async function(){
        if (!deleteTargetForm) return;
        const action = deleteTargetForm.getAttribute('action');
        try {
          const res = await fetch(action, { method: 'POST', headers: { 'Accept': 'application/json' } });
          if (res.ok) {
            let ok = true;
            try { const j = await res.json(); if (j && j.success === false) ok = false; } catch(_) {}
            if (ok) {
              const tr = deleteTargetForm.closest('tr'); if (tr) tr.remove();
              document.getElementById('deleteCustomerModal').style.display = 'none';
              deleteTargetForm = null;
              // show transient success modal instead of alert
              const success = document.getElementById('deleteSuccessModal');
              if (success) {
                success.style.display = 'flex';
                // auto-close after 1.5s
                setTimeout(() => { success.style.display = 'none'; }, 1500);
              } else {
                alert('Customer deleted');
              }
            } else {
              alert('Failed to delete customer');
            }
          } else {
            alert('Failed to delete customer');
          }
        } catch (err) {
          console.error(err);
          alert('Error deleting customer');
        }
      };
    });
  </script>

</body>
</html>
