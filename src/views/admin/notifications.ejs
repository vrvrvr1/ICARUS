<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notifications - Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .notification-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .notification-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .notification-item.unread {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
    }
    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    .notification-title {
      font-weight: 600;
      color: #111827;
      font-size: 15px;
    }
    .notification-time {
      font-size: 13px;
      color: #6b7280;
      white-space: nowrap;
      margin-left: 12px;
    }
    .notification-body {
      color: #4b5563;
      font-size: 14px;
      line-height: 1.5;
    }
    .notification-badge {
      display: inline-block;
      background: #3b82f6;
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .empty-state i {
      font-size: 64px;
      color: #d1d5db;
      margin-bottom: 16px;
    }
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: #f9fafb;
    }
    .filter-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    .mark-all-read-btn {
      padding: 8px 16px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .mark-all-read-btn:hover {
      background: #059669;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="dashboard-sidebar">
    <div>
      <div class="sidebar-profile">
        <img src="/images/avatar.jpg" alt="Admin" class="sidebar-avatar" />
        <div>
          <div class="sidebar-welcome">Welcome back,</div>
          <div class="sidebar-name">Admin</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders"><i class="bi bi-bag-check"></i> Orders</a>
        <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
        <a href="/admin/announcements"><i class="bi bi-megaphone"></i> Announcements</a>
        <a href="/admin/audit-logs"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        <a href="/admin/cms"><i class="bi bi-journal-text"></i> CMS</a>
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
        <a href="/logout" style="color:#ef4444;margin-top:12px;"><i class="bi bi-box-arrow-right"></i> Logout</a>
      </nav>
    </div>

    <div>
      <p class="text-center text-secondary small mb-0">Â© 2025 Icarus Wears</p>
    </div>
  </aside>

  <!-- Main -->
  <main class="dashboard-main">
    <!-- Header -->
    <div class="dashboard-header">
      <div>
        <div class="dashboard-title-main">Notifications</div>
        <div class="dashboard-title-sub">Manage your admin notifications</div>
      </div>
      <button class="mark-all-read-btn" onclick="markAllAsRead()" id="markAllBtn">
        <i class="bi bi-check-all"></i> Mark All as Read
      </button>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="unread">Unread</button>
      <button class="filter-btn" data-filter="orders">Orders</button>
      <button class="filter-btn" data-filter="refunds">Refunds</button>
      <button class="filter-btn" data-filter="cancellations">Cancellations</button>
    </div>

    <!-- Notifications List -->
    <div id="notificationsList">
      <% if (notifications && notifications.length > 0) { %>
        <% notifications.forEach(notification => { %>
          <div class="notification-item <%= !notification.is_read ? 'unread' : '' %>" 
               data-id="<%= notification.id %>"
               data-link="<%= notification.link || '' %>"
               data-type="<%= notification.title.toLowerCase().includes('order') ? 'orders' : (notification.title.toLowerCase().includes('refund') ? 'refunds' : (notification.title.toLowerCase().includes('cancel') ? 'cancellations' : 'other')) %>"
               onclick="handleNotificationClick(this)">
            <div class="notification-header">
              <div style="flex: 1;">
                <span class="notification-title"><%= notification.title %></span>
                <% if (!notification.is_read) { %>
                  <span class="notification-badge">NEW</span>
                <% } %>
              </div>
              <span class="notification-time"><%= new Date(notification.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
            </div>
            <div class="notification-body"><%= notification.body %></div>
          </div>
        <% }); %>
      <% } else { %>
        <div class="empty-state">
          <i class="bi bi-bell-slash"></i>
          <h4>No notifications yet</h4>
          <p>You'll see notifications about orders, cancellations, and refunds here.</p>
        </div>
      <% } %>
    </div>
  </main>

  <script>
    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        const notifications = document.querySelectorAll('.notification-item');
        
        notifications.forEach(notification => {
          if (filter === 'all') {
            notification.style.display = 'block';
          } else if (filter === 'unread') {
            notification.style.display = notification.classList.contains('unread') ? 'block' : 'none';
          } else {
            notification.style.display = notification.dataset.type === filter ? 'block' : 'none';
          }
        });
      });
    });

    // Handle notification click
    async function handleNotificationClick(element) {
      const notificationId = element.dataset.id;
      const link = element.dataset.link;
      
      try {
        // Mark as read
        await fetch('/notifications/mark-read', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ notificationId })
        });

        // Update UI
        element.classList.remove('unread');
        const badge = element.querySelector('.notification-badge');
        if (badge) badge.remove();

        // Navigate to link if provided
        if (link && link.trim() !== '') {
          window.location.href = link;
        }
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    // Mark all as read
    async function markAllAsRead() {
      try {
        const response = await fetch('/notifications/mark-read', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ markAll: true })
        });

        if (response.ok) {
          // Remove all unread indicators
          document.querySelectorAll('.notification-item.unread').forEach(item => {
            item.classList.remove('unread');
            const badge = item.querySelector('.notification-badge');
            if (badge) badge.remove();
          });

          // Show success message
          const btn = document.getElementById('markAllBtn');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<i class="bi bi-check-circle"></i> All marked as read!';
          btn.disabled = true;
          
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
        alert('Failed to mark notifications as read. Please try again.');
      }
    }
  </script>
</body>
</html>
