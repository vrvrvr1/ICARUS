<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order #<%= order.id %></title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    /* Hide scrollbar but keep functionality */
    #refundModal > div:last-child::-webkit-scrollbar {
      display: none;
    }
    
    @media print {
      /* Hide sidebar and navigation elements when printing */
      .dashboard-sidebar,
      .dashboard-header,
      .dashboard-title-sub,
      .dl-card,
      .delivery-section,
      section.delivery-timeline {
        display: none !important;
      }
      
      /* Adjust main content for print */
      .dashboard-main {
        margin: 0 !important;
        padding: 40px !important;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .dashboard-main::before,
      .dashboard-main::after {
        display: none !important;
      }
      
      /* Make text readable */
      body {
        background: white !important;
        color: #000 !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      }
      
      /* Force content to fit on one page */
      @page {
        size: A4;
        margin: 0;
      }
      
      /* Status stepper section */
      .order-stepper-card {
        box-shadow: none !important;
        background: white !important;
        border: none !important;
        padding: 20px !important;
        margin-bottom: 30px !important;
      }
      
      .stepper {
        box-shadow: none !important;
      }
      
      .step {
        box-shadow: none !important;
      }
      
      /* Addresses section */
      .order-addresses {
        display: flex !important;
        justify-content: space-between !important;
        margin: 0 0 30px 0 !important;
        gap: 60px;
        page-break-inside: avoid;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        box-shadow: none !important;
      }
      
      .addr-col {
        flex: 1;
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        box-shadow: none !important;
      }
      
      .addr-title {
        font-weight: 600 !important;
        font-size: 12px !important;
        margin-bottom: 10px;
        color: #666 !important;
        text-transform: none !important;
      }
      
      .addr-body {
        font-size: 13px;
        line-height: 1.6;
      }
      
      .addr-name {
        font-weight: 700 !important;
        color: #000 !important;
        margin-bottom: 4px;
        font-size: 14px;
      }
      
      .addr-line {
        color: #000 !important;
        font-size: 12px;
      }
      
      /* Items section - Table format */
      .order-layout {
        page-break-inside: avoid;
        margin-top: 30px;
        display: flex;
        flex-direction: column;
      }
      
      .order-items {
        width: 100%;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: none !important;
      }
      
      .section-title {
        display: none !important;
      }
      
      /* Convert item list to table format */
      .item-list {
        display: table !important;
        width: 100%;
        border-collapse: collapse;
        margin: 0;
        list-style: none;
        padding: 0;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: none !important;
      }
      
      /* Table header */
      .item-list::before {
        content: 'Item' '\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0' 'Unit price' '\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0' 'Quantity' '\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0\A0' 'Item total';
        display: block;
        font-weight: 600;
        font-size: 12px;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        color: #6b7280;
        background: white;
        white-space: pre;
      }
      
      .item-row {
        display: flex !important;
        padding: 14px 16px !important;
        border-bottom: 1px solid #e5e7eb !important;
        align-items: center;
        background: white !important;
      }
      
      .item-row:last-child {
        border-bottom: none !important;
      }
      
      .item-thumb {
        display: none !important;
      }
      
      .item-info {
        flex: 1;
        min-width: 250px;
      }
      
      .item-name {
        font-weight: 400 !important;
        color: #111827 !important;
        font-size: 13px;
      }
      
      .item-attrs {
        display: none !important;
      }
      
      .item-price {
        width: 100px;
        text-align: right;
        font-weight: 400 !important;
        color: #111827 !important;
        font-size: 13px;
        margin: 0 !important;
      }
      
      .item-row > div:nth-child(3) {
        width: 80px;
        text-align: center;
        font-weight: 400 !important;
        color: #111827 !important;
        font-size: 13px;
      }
      
      .item-subtotal {
        width: 120px;
        text-align: right;
        font-weight: 600 !important;
        color: #111827 !important;
        font-size: 13px;
        margin: 0 !important;
      }
      
      /* Order summary - aligned to right */
      .order-summary {
        border: none !important;
        padding: 20px !important;
        background: #f8f9fa !important;
        border-radius: 8px;
        margin-left: auto;
        width: 350px;
        page-break-inside: avoid;
        box-shadow: none !important;
      }
      
      .sum-row {
        display: flex !important;
        justify-content: space-between !important;
        padding: 10px 0;
        color: #000 !important;
        border: none !important;
        font-size: 13px;
      }
      
      .sum-row span:first-child {
        color: #6b7280;
        font-weight: 400;
      }
      
      .sum-row span:last-child {
        font-weight: 600;
        color: #111827;
      }
      
      .sum-total {
        display: flex !important;
        justify-content: space-between !important;
        padding: 16px 0 0 !important;
        font-size: 18px !important;
        font-weight: 700 !important;
        color: #111827 !important;
        border-top: 2px solid #d1d5db !important;
        border-bottom: none !important;
        margin-top: 10px;
      }
      
      .sum-row.small {
        font-size: 11px !important;
        color: #9ca3af !important;
        border: none !important;
        padding: 8px 0 0 !important;
      }
    }
  </style>
</head>
<body>
  <aside class="dashboard-sidebar">
    <div>
      <div class="sidebar-profile">
        <img src="/image/profile1.png" alt="Admin" class="sidebar-avatar" onerror="this.onerror=null;this.src='/image/profile1.png';" />
        <div>
          <div class="sidebar-welcome">Welcome back,</div>
          <div class="sidebar-name">Admin</div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders" class="active"><i class="bi bi-bag-check"></i> Orders</a>
        <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
        <a href="/admin/audit-logs"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        <a href="/admin/cms"><i class="bi bi-journal-text"></i> CMS</a>
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
      </nav>
    </div>
    <div>
      <p class="text-center text-secondary small mb-0">© 2025 Icarus Wears</p>
    </div>
  </aside>

  <main class="dashboard-main" data-print-date="" data-order-id="TXNID<%= String(order.id).padStart(6,'0') %>">
    <div class="dashboard-header" data-print-date="">
      <div>
        <div class="dashboard-title-main">INVOICE</div>
        <div class="dashboard-title-sub">Order details and delivery information</div>
      </div>
      <div style="display:flex;gap:8px;">
        <% const refundStatus = order.refund_status || ''; %>
        <% if (refundStatus === 'processed') { %>
          <span style="background:#10b981;color:#fff;padding:8px 16px;border-radius:8px;font-weight:600;font-size:13px;display:flex;align-items:center;gap:6px;">
            <i class="bi bi-check-circle-fill"></i> Refunded
          </span>
        <% } else { %>
          <button class="btn" onclick="showRefundModal()" style="background:#f59e0b;display:flex;align-items:center;gap:8px;">
            <i class="bi bi-arrow-counterclockwise"></i> Process Refund
          </button>
        <% } %>
        <button class="btn" onclick="window.print()" style="display:flex;align-items:center;gap:8px;">
          <i class="bi bi-printer"></i> Print Invoice
        </button>
        <a class="analytics-btn" href="/orders">Back to Orders</a>
        <a class="analytics-btn" href="/admin/orders/<%= order.id %>/edit"><i class="bi bi-pencil"></i> Edit</a>
      </div>
    </div>

   <% const st2 = (order.status || '').toLowerCase();
     const stepIndex2 = (st2.includes('delivered') || st2.includes('completed')) ? 3
                : ((st2.includes('en route') || st2.includes('courier') || st2.includes('out')) ? 2
                : (st2.includes('shipped') ? 1 : 0)); %>
    <div class="dl-card">
      <div class="dl-title">Delivery timeline</div>
      <div class="dl-track-wrap">
        <div class="dl-track-bar" data-step="<%= stepIndex2 %>"></div>
      </div>
      <div class="dl-steps">
        <div class="dl-step <%= stepIndex2 >= 0 ? 'done' : '' %>">
          <div class="dl-dot"></div>
          <div class="dl-icon"><i class="bi bi-journal-check"></i></div>
          <div class="dl-label">Order Placed</div>
        </div>
        <div class="dl-step <%= stepIndex2 >= 2 ? 'done' : '' %>">
          <div class="dl-dot"></div>
          <div class="dl-icon"><i class="bi bi-box-seam"></i></div>
          <div class="dl-label">Order Shipped</div>
        </div>
        <div class="dl-step <%= stepIndex2 >= 2 ? 'done' : '' %>">
          <div class="dl-dot"></div>
          <div class="dl-icon"><i class="bi bi-truck"></i></div>
          <div class="dl-label">Order En Route</div>
        </div>
        <div class="dl-step <%= stepIndex2 >= 3 ? 'done' : '' %>">
          <div class="dl-dot"></div>
          <div class="dl-icon"><i class="bi bi-house"></i></div>
          <div class="dl-label">Order Arrived</div>
        </div>
      </div>
      <% 
        const es = order.estimated_delivery_start ? new Date(order.estimated_delivery_start) : null;
        const ee = order.estimated_delivery_end ? new Date(order.estimated_delivery_end) : null;
        const single = order.estimated_delivery ? new Date(order.estimated_delivery) : null;
        function fmtDate(d){ return d ? d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) : ''; }
        function fmtDateFull(d){ return d ? d.toLocaleDateString() : ''; }
        let etaLabel = '';
        if (es && ee){
          if (es.toDateString() === ee.toDateString()) etaLabel = fmtDateFull(es);
          else if (es.getFullYear() === ee.getFullYear() && es.getMonth() === ee.getMonth()) etaLabel = `${fmtDate(es)} – ${ee.getDate()}`;
          else etaLabel = `${fmtDate(es)} – ${fmtDate(ee)}`;
        } else if (es || ee){
          etaLabel = fmtDateFull(es || ee);
        } else if (single){
          etaLabel = fmtDateFull(single);
        }
      %>
      <% if (etaLabel) { %>
        <div class="text-secondary small" style="margin-top:6px;">Estimated delivery: <strong><%= etaLabel %></strong></div>
      <% } %>
    </div>

    <!-- Status stepper and tracking -->
    <section class="order-stepper-card">
      <div class="stepper">
      <% const s = (order.status || '').toLowerCase();
        const pmRaw = (order.payment_method || '');
        const pmUpper = pmRaw.toUpperCase();
        const pmLabel = pmUpper === 'COD' ? 'Cash on Delivery' : (pmUpper === 'PAYPAL' ? 'PayPal' : (pmRaw || '—'));
        const isCOD = pmUpper === 'COD';
        const isPayPal = pmUpper === 'PAYPAL';
        const paid = !!order.payment_completed; // payment flag from DB
        const shipped = /ship|out/.test(s);
        const delivered = /deliver|complete/.test(s);
        const paymentDone = isPayPal || (paid && !isCOD); // PayPal shows as paid; COD never auto-done
      %>
        <div class="step <%= s ? 'done' : '' %>">
          <div class="icon"><i class="bi bi-receipt"></i></div>
          <div class="label">Order made</div>
          <div class="hint">Create order</div>
        </div>
        <div class="step <%= paymentDone ? 'done' : 'danger' %>">
          <div class="icon"><i class="bi bi-credit-card"></i></div>
          <% const pendingLabel = 'Payment Pending'; %>
          <div class="label"><%= paymentDone ? 'Order Paid' : pendingLabel %></div>
          <% if (!isPayPal) { %>
            <div class="hint"><%= paymentDone ? 'Customer payment' : 'Awaiting payment' %></div>
          <% } %>
        </div>
        <div class="step <%= shipped || delivered ? 'active' : '' %>">
          <div class="icon"><i class="bi bi-truck"></i></div>
          <div class="label">Shipped</div>
          <% const inTransit = (s.includes('en route') || s.includes('courier') || s.includes('out')); %>
          <div class="hint">
            <%= delivered ? 'Delivered' : (inTransit ? 'On delivery' : (shipped ? 'Shipped' : (s.includes('process') ? 'Preparing' : 'Pending'))) %>
          </div>
        </div>
        <div class="step <%= delivered ? 'done' : 'danger' %>">
          <div class="icon"><i class="bi bi-bag-check"></i></div>
          <div class="label">Completed</div>
          <div class="hint"><%= delivered ? 'Order completed' : 'Not completed' %></div>
        </div>
      </div>
      <div class="resi">Tracking No: <strong><%= order.paypal_order_id || '—' %></strong></div>
    </section>

    <!-- Addresses -->
    <section class="order-addresses">
      <div class="addr-col">
        <div class="addr-title">Shipping Address (Seller)</div>
        <div class="addr-body">
          <div class="addr-name"><%= store?.name || 'Icarus Store' %></div>
          <div class="addr-line"><%= store?.address || 'Manila, Philippines' %></div>
        </div>
      </div>
      <div class="addr-col">
        <div class="addr-title">Shipping Address (Buyer)</div>
        <div class="addr-body">
          <div class="addr-name"><%= order.ship_first_name || '' %> <%= order.ship_last_name || '' %></div>
          <div class="addr-line"><%= order.ship_address %><% if (order.ship_city) { %>, <%= order.ship_city %><% } %><% if (order.ship_province) { %>, <%= order.ship_province %><% } %><% if (order.ship_zipcode) { %>, <%= order.ship_zipcode %><% } %></div>
        </div>
      </div>
    </section>

    <!-- Items and Summary -->
    <section class="order-layout">
      <div class="order-items">
        <div class="section-title">Order Item</div>
        <ul class="item-list">
          <% (items || []).forEach(it => { %>
            <li class="item-row">
              <img class="item-thumb" src="<%= it.image_url || '/image/placeholder.png' %>" alt="thumb" onerror="this.src='/image/placeholder.png'" />
              <div class="item-info">
                <div class="item-name"><%= it.product_name %></div>
                <div class="item-attrs">Qty: <%= it.quantity %></div>
              </div>
              <div class="item-price">$<%= Number(it.price || 0).toLocaleString() %></div>
              <div class="item-subtotal">$<%= Number(it.subtotal || 0).toLocaleString() %></div>
            </li>
          <% }) %>
        </ul>
      </div>
      <aside class="order-summary">
        <div class="section-title">Order Summary</div>
        <div class="sum-row"><span>Subtotal</span><span>$<%= Number(order.subtotal || 0).toLocaleString() %></span></div>
        <div class="sum-row"><span>Tax</span><span>$<%= Number(order.tax || 0).toLocaleString() %></span></div>
        <div class="sum-row"><span>Shipping</span><span>$<%= Number(order.shipping || 0).toLocaleString() %></span></div>
        <div class="sum-total"><span>Total</span><span>$<%= Number(order.total || order.total_amount || 0).toLocaleString() %></span></div>
  <div class="sum-row small muted" style="margin-top:8px;">Payment: <%= order.payment_completed ? pmLabel : 'Pending' %></div>
      </aside>
    </section>
  </main>
  <!-- Refund Modal -->
  <div id="refundModal" role="dialog" aria-modal="true" aria-labelledby="refundModalTitle" style="display:none; position:fixed; inset:0; z-index:11000; overflow-y:auto;">
    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.6);" onclick="hideRefundModal()"></div>
    <div style="max-width:580px; margin:60px auto 60px; background:#fff; border-radius:16px; padding:28px; position:relative; box-shadow:0 20px 50px rgba(0,0,0,0.4); max-height:calc(100vh - 120px); overflow-y:auto; scrollbar-width:none; -ms-overflow-style:none;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="width:48px;height:48px;background:#fff7ed;border-radius:50%;display:flex;align-items:center;justify-content:center;">
          <i class="bi bi-arrow-counterclockwise" style="color:#f59e0b;font-size:24px;"></i>
        </div>
        <h2 id="refundModalTitle" style="margin:0; font-size:20px;color:#1f2937;font-weight:700;">Process Refund</h2>
      </div>
      
      <div style="margin-bottom:20px;">
        <p style="color:#4b5563;font-size:15px;line-height:1.6;margin:0 0 16px 0;">
          Process a refund for Order #<%= order.id %>
        </p>
        
        <div style="background:#fff7ed;border-left:4px solid #f59e0b;border-radius:6px;padding:12px 16px;margin-bottom:20px;">
          <div style="color:#92400e;font-size:14px;line-height:1.7;">
            <strong>Payment Method:</strong> <%= order.payment_method || 'N/A' %><br>
            <strong>Refund Amount:</strong> $<%= Number(order.total || 0).toFixed(2) %> (Full Refund)
          </div>
        </div>
        
        <% if (order.payment_method === 'COD') { %>
        <div style="background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;padding:12px 16px;margin-bottom:16px;">
          <p style="color:#92400e;font-size:13px;line-height:1.6;margin:0;">
            <i class="bi bi-cash-coin"></i> <strong>COD Refund Instructions:</strong><br>
            Customer paid in cash. You must process the refund manually via:
          </p>
          <ul style="color:#92400e;font-size:13px;margin:8px 0 0 20px;padding:0;">
            <li>Bank transfer to customer's account</li>
            <li>E-Wallet transfer (GCash, PayMaya, etc.)</li>
          </ul>
          <p style="color:#92400e;font-size:12px;margin:8px 0 0 0;font-style:italic;">
            Please coordinate with customer for their preferred refund method.
          </p>
        </div>
        <% } %>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;font-size:13px;margin-bottom:6px;font-weight:600;color:#374151;">Reason for Refund</label>
          <select id="refundReason" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;">
            <option value="">Select reason...</option>
            <option value="Customer request">Customer request</option>
            <option value="Product defect">Product defect</option>
            <option value="Wrong item sent">Wrong item sent</option>
            <option value="Item not received">Item not received</option>
            <option value="Order cancelled">Order cancelled</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <% if (order.payment_method === 'COD') { %>
        <div style="margin-bottom:16px;">
          <label style="display:block;font-size:13px;margin-bottom:6px;font-weight:600;color:#374151;">Refund Method <span style="color:#dc2626;">*</span></label>
          <select id="codRefundMethod" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;">
            <option value="">Select refund method...</option>
            <option value="Bank Transfer">Bank Transfer</option>
            <option value="E-Wallet">E-Wallet (GCash, PayMaya, etc.)</option>
          </select>
        </div>
        <% } %>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;font-size:13px;margin-bottom:6px;font-weight:600;color:#374151;">Admin Notes <% if (order.payment_method === 'COD') { %><span style="color:#dc2626;">*</span> (Specify customer contact and refund details)<% } else { %>(Optional)<% } %></label>
          <textarea id="adminNotes" rows="3" placeholder="<% if (order.payment_method === 'COD') { %>Add customer contact info and refund arrangement details...<% } else { %>Add internal notes about this refund...<% } %>" style="width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:14px;resize:vertical;"></textarea>
        </div>
        
        <div style="background:#fef2f2;border-left:4px solid #dc2626;border-radius:6px;padding:12px 16px;margin-bottom:8px;">
          <p style="color:#991b1b;font-size:13px;line-height:1.6;margin:0;">
            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Warning:</strong> This action cannot be undone. 
            <% if (order.payment_method === 'PayPal') { %>
              The system will automatically process the refund through PayPal API.
            <% } else if (order.payment_method === 'COD') { %>
              This will mark the order as refunded in the system. You must manually return the cash to the customer.
            <% } else { %>
              Please ensure you have processed the actual refund through your payment processor before clicking Process Refund.
            <% } %>
          </p>
        </div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:20px; padding-top:16px; border-top:1px solid #e5e7eb;">
        <button onclick="hideRefundModal()" type="button" style="background:#fff;color:#374151;padding:12px 24px;border-radius:8px;border:1px solid #d1d5db;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
          Cancel
        </button>
        <button id="processRefundBtn" onclick="processRefund()" type="button" style="background:#f59e0b;color:#fff;padding:12px 28px;border-radius:8px;border:none;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px;box-shadow:0 2px 8px rgba(245,158,11,0.3);transition:all 0.2s;" onmouseover="this.style.background='#d97706';this.style.boxShadow='0 4px 12px rgba(217,119,6,0.4)'" onmouseout="this.style.background='#f59e0b';this.style.boxShadow='0 2px 8px rgba(245,158,11,0.3)'">
          <i class="bi bi-arrow-counterclockwise"></i> Process Refund
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" role="dialog" aria-modal="true" style="display:none; position:fixed; inset:0; z-index:12000;">
    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.6);"></div>
    <div style="max-width:440px; margin:auto; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; border-radius:12px; padding:24px; box-shadow:0 20px 50px rgba(0,0,0,0.4);">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="width:48px;height:48px;background:#fef2f2;border-radius:50%;display:flex;align-items:center;justify-content:center;">
          <i class="bi bi-exclamation-triangle-fill" style="color:#dc2626;font-size:24px;"></i>
        </div>
        <h3 style="margin:0;font-size:18px;color:#1f2937;font-weight:700;">Confirm Refund</h3>
      </div>
      
      <p style="color:#4b5563;font-size:14px;line-height:1.6;margin:0 0 20px 0;">
        Are you sure you want to process a <strong>full refund</strong> of <strong style="color:#dc2626;">$<span id="confirmAmount">0.00</span></strong>?
      </p>
      
      <p style="color:#6b7280;font-size:13px;line-height:1.5;margin:0 0 20px 0;font-style:italic;">
        This action cannot be undone.
      </p>
      
      <div style="display:flex;justify-content:flex-end;gap:10px;">
        <button onclick="hideConfirmationModal()" type="button" style="background:#fff;color:#374151;padding:10px 20px;border-radius:8px;border:1px solid #d1d5db;font-weight:600;cursor:pointer;font-size:14px;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='#fff'">
          Cancel
        </button>
        <button onclick="confirmRefundAction()" type="button" style="background:#dc2626;color:#fff;padding:10px 24px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:14px;box-shadow:0 2px 8px rgba(220,38,38,0.3);" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
          Yes, Process Refund
        </button>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div id="successToast" style="display:none;position:fixed;top:20px;right:20px;background:#10b981;color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:12000;font-weight:600;">
    <i class="bi bi-check-circle-fill"></i> <span id="toastMessage">Refund processed successfully</span>
  </div>

  <script>
    const ORDER_ID = Number('<%= order.id %>');
    const ORDER_TOTAL = Number('<%= Number(order.total || 0).toFixed(2) %>');
    
    // Show/hide refund modal
    function showRefundModal() {
      document.getElementById('refundModal').style.display = 'block';
    }
    
    function hideRefundModal() {
      document.getElementById('refundModal').style.display = 'none';
    }
    
    // Show/hide confirmation modal
    function showConfirmationModal(amount) {
      document.getElementById('confirmAmount').textContent = amount.toFixed(2);
      document.getElementById('confirmationModal').style.display = 'block';
    }
    
    function hideConfirmationModal() {
      document.getElementById('confirmationModal').style.display = 'none';
    }
    
    // Process refund (validation only)
    async function processRefund() {
      const refundReason = document.getElementById('refundReason').value;
      let adminNotes = document.getElementById('adminNotes').value;
      const btn = document.getElementById('processRefundBtn');
      const paymentMethod = '<%= order.payment_method %>';
      
      // Validation
      if (!refundReason) {
        alert('Please select a reason for the refund');
        return;
      }
      
      // COD-specific validation
      if (paymentMethod === 'COD') {
        const codRefundMethodEl = document.getElementById('codRefundMethod');
        const codRefundMethod = codRefundMethodEl ? codRefundMethodEl.value : '';
        
        if (!codRefundMethod) {
          alert('Please select a refund method for COD order');
          return;
        }
        
        if (!adminNotes.trim()) {
          alert('Please add notes with customer contact details and refund arrangement');
          return;
        }
        
        // Append COD refund method to notes
        adminNotes = `COD Refund Method: ${codRefundMethod}\n\n${adminNotes}`;
      }
      
      // Full refund only
      const refundAmount = ORDER_TOTAL;
      const refundType = 'full';
      
      // Store data for confirmation
      window.pendingRefundData = {
        refundAmount,
        refundReason,
        refundType,
        adminNotes
      };
      
      // Show confirmation modal
      showConfirmationModal(refundAmount);
    }
    
    // Confirm and execute refund
    async function confirmRefundAction() {
      const refundData = window.pendingRefundData;
      if (!refundData) return;
      
      hideConfirmationModal();
      
      const btn = document.getElementById('processRefundBtn');
      
      // Disable button and show loading
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
      
      try {
        const response = await fetch(`/admin/orders/${ORDER_ID}/refund`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            refund_amount: refundData.refundAmount,
            refund_reason: refundData.refundReason,
            refund_type: refundData.refundType,
            admin_notes: refundData.adminNotes
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          hideRefundModal();
          showToast('Refund processed successfully!');
          // Reload page after 1.5 seconds
          setTimeout(() => window.location.reload(), 1500);
        } else {
          alert('Error: ' + (result.error || 'Failed to process refund'));
          btn.disabled = false;
          btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Process Refund';
        }
      } catch (error) {
        console.error('Error processing refund:', error);
        alert('Error: Failed to process refund. Please try again.\n\nDetails: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-counterclockwise"></i> Process Refund';
      }
    }
    
    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('successToast');
      const msg = document.getElementById('toastMessage');
      msg.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
    
    document.addEventListener('DOMContentLoaded', function(){
      // Set print date
      const main = document.querySelector('.dashboard-main');
      const header = document.querySelector('.dashboard-header');
      if (main && header) {
        const now = new Date();
        const formattedDate = now.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
        main.setAttribute('data-print-date', formattedDate);
        header.setAttribute('data-print-date', formattedDate);
      }
      
      // Delivery timeline bar animation
      function setBarToIndex(wrap){
        var bar = wrap.querySelector('.dl-track-bar');
        if (!bar) return;
        var idx = parseInt(bar.getAttribute('data-step'), 10);
        if (isNaN(idx)) idx = 0;
        var steps = wrap.parentElement.querySelectorAll('.dl-steps .dl-step');
        if (!steps || !steps.length) return;
        var i = Math.min(Math.max(idx, 0), steps.length - 1);
        var dot = steps[i].querySelector('.dl-dot');
        if (!dot) return;
        var wrapRect = wrap.getBoundingClientRect();
        var dotRect = dot.getBoundingClientRect();
        var centerX = dotRect.left + (dotRect.width/2);
        var widthPx = Math.max(0, Math.min(centerX - wrapRect.left, wrap.clientWidth));
        bar.style.width = widthPx + 'px';
      }
      document.querySelectorAll('.dl-track-wrap').forEach(function(wrap){ setBarToIndex(wrap); });
      window.addEventListener('resize', function(){
        document.querySelectorAll('.dl-track-wrap').forEach(function(wrap){ setBarToIndex(wrap); });
      });
    });
  </script>
</body>
</html>
