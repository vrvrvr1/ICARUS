<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Orders</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/admin.css">
  </head>

  <body>
    <!-- Sidebar (reuse admin layout markup) -->
    <aside class="dashboard-sidebar">
      <div>
        <div class="sidebar-profile">
          <img src="/image/profile1.png" alt="Admin" class="sidebar-avatar" onerror="this.onerror=null;this.src='/image/profile1.png';" />
          <div>
            <div class="sidebar-welcome">Welcome back,</div>
            <div class="sidebar-name">Admin</div>
          </div>
        </div>

        <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders" class="active"><i class="bi bi-bag-check"></i> Orders</a>
        <a href="/admin/discounts"><i class="bi bi-percent"></i> Discounts</a>
        <a href="/admin/audit-logs"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        <a href="/admin/cms"><i class="bi bi-journal-text"></i> CMS</a>
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
  </nav>
      </div>

      <div>
        <p class="text-center text-secondary small mb-0">Â© 2025 Icarus Wears</p>
      </div>
    </aside>

    <!-- Main content area -->
    <main class="dashboard-main">
      <div class="dashboard-header">
        <div>
          <div class="dashboard-title-main">Orders</div>
          <div class="dashboard-title-sub">Manage and review customer orders</div>
        </div>
        <div style="display:flex;align-items:center;gap:16px;">
          <a href="/admin/notifications" style="position:relative;font-size:24px;color:#3b82f6;text-decoration:none;">
            <i class="bi bi-bell-fill"></i>
            <span id="notif-badge" style="display:none;position:absolute;top:-8px;right:-8px;background:#ef4444;color:white;border-radius:10px;padding:2px 6px;font-size:11px;font-weight:600;min-width:18px;text-align:center;"></span>
          </a>
          <div class="dashboard-search">
            <input type="text" placeholder="Search orders or customer" />
            <i class="bi bi-search"></i>
          </div>
        </div>
      </div>

      <div class="dashboard-orders">
        <div class="orders-title-row">
          <div class="orders-title">All Orders</div>
          <div style="margin-left:auto">
            <select class="filter" onchange="location.href='/orders?range=' + this.value">
              <option value="this-week" <%= (typeof range !== 'undefined' && range === 'this-week') ? 'selected' : '' %>>This Week</option>
              <option value="this-month" <%= (typeof range === 'undefined' || range === 'this-month') ? 'selected' : '' %>>This Month</option>
              <option value="last-month" <%= (typeof range !== 'undefined' && range === 'last-month') ? 'selected' : '' %>>Last Month</option>
              <option value="all" <%= (typeof range !== 'undefined' && range === 'all') ? 'selected' : '' %>>All Time</option>
            </select>
          </div>
        </div>

        <table class="orders-table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Customer</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (!orders || orders.length === 0) { %>
              <tr>
                <td colspan="6">No orders found.</td>
              </tr>
            <% } else { %>
              <% orders.forEach(order => { %>
                <tr class="<%=
                  (/deliver|complete/i.test(order.status || '')) ? 'row-delivered' : ''
                %>">
                  <td>#<%= order.id %></td>
                  <td>
                    <div style="display:flex; align-items:center; gap:12px">
                      <img src="<%= order.customer_image || '/image/profile1.png' %>" alt="avatar" class="order-thumb" onerror="this.src='/image/profile1.png'" />
                      <div>
                        <div><%= order.customer_name %></div>
                        <div class="small text-secondary"><%= order.customer_email %></div>
                      </div>
                    </div>
                  </td>
                  <td><%= order.order_date ? new Date(order.order_date).toLocaleDateString() : 'N/A' %></td>
                  <td>
                    $<%= Number(order.total_amount || 0).toLocaleString() %>
                    <% if (order.refund_status === 'processed' && order.refund_amount) { %>
                      <div style="font-size:11px;color:#10b981;margin-top:2px;">
                        <i class="bi bi-arrow-counterclockwise"></i> Refunded: $<%= Number(order.refund_amount).toFixed(2) %>
                      </div>
                    <% } %>
                  </td>
                  <td>
              <% const s = (order.status || '').toLowerCase();
                       const isRefunded = order.refund_status === 'processed';
                       const isCancelledByUser = !!order.cancelled_at || /cancel/.test(s);
                       const isDelivered = /deliver|complete/.test(s);
                       const isPending = /pend/.test(s);
                       const isInTransit = /en route|courier|out/.test(s);
                       const isShipped = /ship/.test(s);
                const isProcessing = /process/.test(s);
                       const cls = isRefunded ? 'completed' : (isCancelledByUser ? 'cancelled' : (isDelivered ? 'completed' : (
                         isPending ? 'pending' : (
                         isInTransit ? 'intransit' : (
                         isShipped ? 'shipped' : (
                         isProcessing ? 'processing' : '' ))))));
                       const icon = isRefunded ? 'bi-arrow-counterclockwise' : (isCancelledByUser ? 'bi-x-circle' : (isDelivered ? 'bi-bag-check' : (
                         isInTransit || isShipped ? 'bi-truck' : (
                         isProcessing ? 'bi-gear' : (
                         isPending ? 'bi-hourglass-split' : 'bi-dot')))));
                       const refundClass = isRefunded ? 'refunded' : '';
                    %>
                    <span class="order-status <%= cls %> <%= isDelivered ? 'delivered' : '' %> <%= refundClass %>">
                      <i class="bi <%= icon %>"></i>
                      <% if (isRefunded) { %>
                        Refunded
                      <% } else if (isCancelledByUser) { %>
                        Cancelled
                        <% if (order.cancellation_reason) { %>
                          <span class="hint" title="<%= order.cancellation_reason %>">by customer</span>
                        <% } %>
                      <% } else if (isInTransit) { %>
                        <strong>Shipped</strong>
                        <span class="hint">On delivery</span>
                      <% } else { %>
                        <%= order.status || 'N/A' %>
                      <% } %>
                    </span>
                  </td>
                  <td>
                    <a class="btn-action" title="View" href="/admin/orders/<%= order.id %>"><i class="bi bi-eye-fill"></i></a>
                    <a class="btn-action" title="Edit" href="/admin/orders/<%= order.id %>/edit"><i class="bi bi-pencil-fill"></i></a>
                    <form action="/admin/orders/<%= order.id %>/delete" method="POST" style="display:inline-block;margin:0;" onsubmit="return confirm('Delete order #<%= order.id %>? This cannot be undone.');">
                      <button class="btn-action" title="Delete" type="submit"><i class="bi bi-trash3-fill"></i></button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </main>

    <script>
      // Fetch notification count
      (async function fetchNotificationCount() {
        try {
          const response = await fetch('/notifications/count');
          const data = await response.json();
          const badge = document.getElementById('notif-badge');
          
          if (data.count > 0) {
            badge.textContent = data.count > 99 ? '99+' : data.count;
            badge.style.display = 'block';
          }
        } catch (error) {
          console.error('Error fetching notification count:', error);
        }
      })();
    </script>
  </body>
</html>
