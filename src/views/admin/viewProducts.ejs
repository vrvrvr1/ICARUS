<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>View Product</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
  <!-- Sidebar (reuse dashboard sidebar) -->
  <aside class="dashboard-sidebar">
    <div>
      <div class="sidebar-profile">
        <img src="/images/avatar.jpg" alt="Admin" class="sidebar-avatar" />
        <div>
          <div class="sidebar-welcome">Welcome back,</div>
          <div class="sidebar-name">Admin</div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin"><i class="bi bi-house-door"></i> Dashboard</a>
        <a href="/admin/sales"><i class="bi bi-graph-up"></i> Sales</a>
        <a href="/adminproducts" class="active"><i class="bi bi-box-seam"></i> Products</a>
        <a href="/customers"><i class="bi bi-people"></i> Customers</a>
        <a href="/orders"><i class="bi bi-bag-check"></i> Orders</a>
        
        <a href="/admin/settings"><i class="bi bi-gear"></i> Settings &amp; Configuration</a>
      </nav>
    </div>

    <div>
      <p class="text-center text-secondary small mb-0">© 2025 Icarus Wears</p>
    </div>
  </aside>

  <main class="dashboard-main">
    <div class="dashboard-header">
      <div>
        <div class="dashboard-title-main">View Product</div>
        <div class="dashboard-title-sub">Product details and metadata</div>
      </div>
    </div>

    <div style="max-width:980px;margin:0 auto;">
      <div class="dashboard-card product-card">
        <% // support multiple images: prefer product.images array, otherwise collect available image fields (image, image2, image_url, etc.) and remove duplicates %>
        <%
          let images = [];
          if (product.images && Array.isArray(product.images) && product.images.length) {
            images = product.images.slice();
          } else {
            // push common image fields in priority order (include image_url_2)
            [product.image, product.image2, product.image_url, product.image_url_2, product.image_path, product.photo, product.img].forEach(i => { if (i) images.push(i); });
          }
          // normalize and dedupe while keeping order
          const seen = new Set();
          images = images.map(i => String(i)).filter(i => i && !seen.has(i) && (seen.add(i), true));
          const mainImg = images[0] || '/image/profile1.png';
          function hrefify(src){ return src && (/^https?:\/\//i.test(src) || src.startsWith('/')) ? src : ('/uploads/' + src); }
  %>
        <div class="product-media">
          <img id="mainProductImage" src="<%= hrefify(mainImg) %>" alt="<%= product.name %>" class="product-large-thumb" onerror="this.onerror=null;this.src='/image/profile1.png'">
          <% if (images.length > 0) { %>
            <div class="thumbnails" id="thumbs">
              <% images.forEach((img, idx) => { %>
                <img data-src="<%= hrefify(img) %>" class="thumb-item <%= idx===0 ? 'active' : '' %>" src="<%= hrefify(img) %>" onerror="this.onerror=null;this.src='/image/profile1.png'" />
              <% }) %>
            </div>
          <% } %>
        </div>

        <div class="product-main">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
            <h3 class="product-title"><%= product.name %></h3>
            <div style="display:flex;gap:8px;align-items:center;">
              <!-- Back button moved here (upper-right) -->
              <button class="btn" onclick="location.href='/adminproducts'">← Back to Products</button>
            </div>
          </div>

          <div style="margin-top:8px;display:flex;align-items:center;gap:12px;">
            <div class="price-badge">$<%= Number(product.price || 0).toFixed(2) %></div>
          </div>

          <p style="margin-top:12px;color:var(--text-secondary);"><%= product.short_description || (product.description ? product.description.substring(0,220) : '') %></p>

          <div class="kpi-row" style="margin-top:12px;">
            <div class="dashboard-card" style="padding:10px;min-width:120px;">
              <div class="card-label">Units Sold</div>
              <div class="card-value"><%= product.sold || 0 %></div>
            </div>
            <div class="dashboard-card" style="padding:10px;min-width:120px;">
              <div class="card-label">Revenue</div>
              <div class="card-value">$<%= Number(product.revenue || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) %></div>
            </div>
          </div>

          <div class="product-summary" style="margin-top:18px;color:var(--text-secondary);">
            <div class="product-detail"><span class="attr-label">Category:</span> <%= product.category || '—' %></div>
            <% if (product.description) { %>
              <div class="product-detail"><span class="attr-label">Description:</span>
                <div style="margin-top:6px;color:var(--text-secondary);font-size:0.95rem;"><%= product.description %></div>
              </div>
            <% } %>

            <!-- additional images are shown as thumbnails under the main image; removed duplicate rendering here -->

            <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
              <div class="product-detail" style="margin:0;padding:0"><span class="attr-label">Stock:</span> <span style="color:var(--text-primary);font-weight:600;"><%= product.stock %> items</span></div>
            </div>

            <div style="margin-top:18px;">
              <h4 style="margin:0 0 8px 0;color:var(--text-primary)">Ratings & Reviews</h4>
              <% const _bd = (product.reviewBreakdown && product.reviewBreakdown.counts) ? product.reviewBreakdown : { counts:{1:0,2:0,3:0,4:0,5:0}, total: 0 }; %>
              <div class="dashboard-card" style="padding:12px;">
                <div style="display:grid;grid-template-columns:1fr 220px;gap:16px;align-items:center;">
                  <div>
                    <% for (let star = 5; star >= 1; star--) { const count = _bd.counts[star] || 0; const total = _bd.total || 0; const pct = total>0 ? Math.round((count/total)*100) : 0; %>
                      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <div style="width:56px;color:#6b6b6b;font-size:0.85rem;">
                          <%= (star===5?'Five':star===4?'Four':star===3?'Three':star===2?'Two':'One') %>
                        </div>
                        <i class="bi bi-star-fill" style="color:#f4b400;font-size:0.9rem;"></i>
                        <div class="progress" style="flex:1;height:8px;background:#f3f3f3;">
                          <div class="progress-bar" style="background:#f4b400;" data-pct="<%= pct %>"></div>
                        </div>
                        <div style="width:56px;text-align:right;color:#777;font-size:0.85rem;"><%= count.toLocaleString() %></div>
                      </div>
                    <% } %>
                  </div>
                  <div style="background:#fff9e6;border:1px solid #fde9ae;border-radius:10px;padding:16px;text-align:center;">
                    <div style="font-size:28px;font-weight:700;color:#4a4a4a;"><%= (Number(product.rating)||0).toFixed(1) %></div>
                    <div style="color:#f4b400;margin:6px 0;">
                      <% const rFull2 = Math.floor(product.rating || 0); const rPart2 = (product.rating || 0) - rFull2; const rEmpty2 = 5 - rFull2 - (rPart2 > 0 ? 1 : 0); %>
                      <% for (let i = 0; i < rFull2; i++) { %><i class="bi bi-star-fill"></i><% } %>
                      <% if (rPart2 > 0) { %>
                        <% if (rPart2 >= 0.75) { %><i class="bi bi-star-fill"></i><% } else if (rPart2 >= 0.25) { %><i class="bi bi-star-half"></i><% } else { %><i class="bi bi-star"></i><% } %>
                      <% } %>
                      <% for (let i = 0; i < rEmpty2; i++) { %><i class="bi bi-star"></i><% } %>
                    </div>
                    <div style="color:#777;font-size:0.9rem;"><%= (_bd.total || product.reviews || 0).toLocaleString() %> Ratings</div>
                  </div>
                </div>
              </div>

              <div class="dashboard-card" style="padding:12px;margin-top:12px;">
                <h5 style="margin:0 0 8px 0;">Recent reviews</h5>
                <% if (typeof reviews !== 'undefined' && reviews && reviews.length) { %>
                  <div class="list-group list-group-flush">
                    <% reviews.forEach(function(r){ %>
                      <div class="list-group-item" style="padding:10px 0;border:none;border-bottom:1px solid #eee;">
                        <div style="display:flex;gap:12px;align-items:flex-start;">
                          <img src="<%= r.user_avatar || '/image/profile1.png' %>" alt="avatar" class="rounded-circle" style="width:40px;height:40px;object-fit:cover;" onerror="this.onerror=null;this.src='/image/profile1.png'" />
                          <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                              <strong><%= r.user_name || 'Anonymous' %></strong>
                              <span style="color:#888;font-size:0.85rem;"><%= r.created_at ? new Date(r.created_at).toLocaleDateString() : '' %></span>
                            </div>
                            <div style="color:#f4b400;margin-bottom:4px;">
                              <% const rr = Math.max(0, Math.min(5, Number(r.rating || 0))); %>
                              <% for (let i = 0; i < Math.floor(rr); i++) { %><i class="bi bi-star-fill"></i><% } %>
                              <% for (let i = Math.floor(rr); i < 5; i++) { %><i class="bi bi-star"></i><% } %>
                            </div>
                            <div style="color:var(--text-secondary);font-size:0.95rem;"><%= r.comment || '' %></div>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                <% } else { %>
                  <div style="color:#777;">No reviews yet for this product.</div>
                <% } %>
              </div>
            </div>

            <!-- Back button has been moved to the header -->
          </div>

        </div>
      </div>
    </div>

    <script>
      // thumbnail click -> swap main image
      document.addEventListener('DOMContentLoaded', function(){
        const thumbs = document.getElementById('thumbs');
        const main = document.getElementById('mainProductImage');
        if(thumbs && main){
          thumbs.addEventListener('click', function(e){
            const t = e.target.closest('.thumb-item');
            if(!t) return;
            document.querySelectorAll('.thumb-item').forEach(i=>i.classList.remove('active'));
            t.classList.add('active');
            main.src = t.getAttribute('data-src') || t.src;
          });
        }

        // tabs removed - view-only page

        // Set progress widths for review breakdown
        document.querySelectorAll('.progress-bar[data-pct]').forEach(el => {
          const pct = Math.max(0, Math.min(100, Number(el.getAttribute('data-pct') || 0)));
          el.style.width = pct + '%';
        });
      });
    </script>

  </main>
</body>
</html>
