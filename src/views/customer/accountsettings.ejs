<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Settings</title>
  <link rel="stylesheet" href="/css/accountsettings.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#2563eb">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
</head>
<body>
  <nav>
    <%- include ("../partials/header.ejs") %>
  </nav>

  <% if (typeof notice !== 'undefined' && notice) { %>
    <div class="alert <%= notice.type === 'error' ? 'alert-danger' : 'alert-success' %>" role="alert" style="margin:16px auto; max-width:1120px;">
      <%= notice.message %>
    </div>
  <% } %>

  <div class="container">
    <div class="settings-box" role="region" aria-label="Account settings">
      <!-- Sidebar left -->
      <aside class="sidebar" aria-label="Settings navigation">
        <h3>My Account</h3>
        <ul>
          <li class="active" data-section="general"><i class="fa-regular fa-circle"></i> Overview</li>
          <li data-section="account"><i class="fa-solid fa-user"></i> Profile</li>
          <li data-section="orders"><i class="fa-solid fa-box"></i> Orders</li>
          <li data-section="wishlist"><i class="fa-regular fa-heart"></i> Wishlist</li>
          <li data-section="languages"><i class="fa-solid fa-language"></i> Language</li>
          <li data-section="privacy"><i class="fa-solid fa-shield-halved"></i> Privacy</li>
          <li data-section="help"><i class="fa-regular fa-circle-question"></i> Help</li>
          <li>
            <form action="/logout" method="GET" style="margin:0; padding:0;">
              <button type="submit" class="logout-btn">
                <i class="fa-solid fa-right-from-bracket"></i> Logout
              </button>
            </form>
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <div class="content">

        <!-- Overview Section -->
        <section class="section active" id="general" aria-labelledby="overview-title">
          <div class="account-header">
            <div class="avatar-wrap">
              <img src="<%= user.profile_pic || user.profile_image || '/image/profile1.png' %>" alt="Profile picture" id="profilePreview">
              <div class="account-meta">
                <% const firstName = user.first_name || (user.email ? user.email.split('@')[0] : 'friend');
                   const cartCount = Number(typeof cartItemCount !== 'undefined' ? cartItemCount : 0);
                %>
                <h3 id="overview-title">Hey <%= firstName %>, great to see you again — your cart is waiting<%= cartCount > 0 ? (' (' + cartCount + ' item' + (cartCount===1 ? '' : 's') + ')') : '' %>!</h3>
               
              </div>
            </div>
          </div>

          

          <!-- Overview grid with user info, recent orders, wishlist, notifications, announcements -->
          <section class="overview-grid" aria-label="Overview widgets">
            <div class="ov-col">
              <!-- 1) User Information Card -->
              <div class="info-card">
                <div class="ic-head">
                  <h5 class="m-0">User Information</h5>
                </div>
                <div class="ic-body">
                  <div class="ic-row">
                    <span class="ic-label">Name</span>
                    <span class="ic-value"><%= (user.first_name || '') + (user.last_name ? ' ' + user.last_name : (user.first_name ? '' : user.email)) %></span>
                  </div>
                  <div class="ic-row">
                    <span class="ic-label">Email</span>
                    <span class="ic-value"><%= user.email %></span>
                  </div>
                  <div class="ic-row">
                    
                  </div>
                </div>
                <div class="ic-foot">
                  <a href="#" class="view-link" onclick="event.preventDefault(); document.querySelector('[data-section=\'account\']').click();">Manage profile</a>
                </div>
              </div>

              <!-- 2) Recent Orders / Activities -->
              <div class="info-card">
                <div class="ic-head d-flex">
                  <h5 class="m-0">Recent orders</h5>
                  <a href="/accountsettings?tab=orders" class="view-link">See all</a>
                </div>
                <div class="ic-body">
                  <% const recent = (myOrders || []).slice(0,5); %>
                  <% if (recent.length) { %>
                    <ul class="list-clean">
                      <% recent.forEach(o => { %>
                        <li class="lo-item" onclick="window.location.href='/orders/<%= o.id %>/track'" role="button" tabindex="0">
                          <div class="lo-main">
                            <div class="lo-id">Order #<%= o.id %></div>
                            <div class="lo-date"><%= o.order_date ? new Date(o.order_date).toLocaleString() : '' %></div>
                          </div>
                          <div class="lo-side">
                            <% const __s = String(o.status||'').toLowerCase();
                               const __cls = (__s.includes('deliver') || __s.includes('complete')) ? 'done'
                                             : (__s.includes('process') ? 'processing'
                                               : (/ship|en route|courier|out/.test(__s) ? 'intransit' : ''));
                            %>
                            <span class="status-text <%= __cls %>"><%= o.status || 'Pending' %></span>
                            <div class="lo-total">$<%= Number(o.total_amount || 0).toLocaleString() %></div>
                          </div>
                        </li>
                      <% }) %>
                    </ul>
                  <% } else { %>
                    <p class="empty">No recent orders.</p>
                  <% } %>
                </div>
              </div>

              <!-- 3) Wishlist preview -->
              <div class="info-card">
                <div class="ic-head d-flex">
                  <h5 class="m-0">Wishlist</h5>
                  <a href="/accountsettings?tab=wishlist" class="view-link">Manage</a>
                </div>
                <div class="ic-body">
                  <% const wl = (wishlistItems || []).slice(0,3); %>
                  <% if (wl.length) { %>
                    <ul class="list-clean">
                      <% wl.forEach(w => { %>
                        <li class="wl-item">
                          <img src="<%= w.image_url %>" alt="<%= w.product_name %>" class="wl-thumb" />
                          <div class="wl-main">
                            <div class="wl-name"><%= w.product_name %></div>
                            <div class="wl-price">$<%= Number(w.price || 0).toLocaleString() %></div>
                          </div>
                        </li>
                      <% }) %>
                    </ul>
                  <% } else { %>
                    <p class="empty">Your wishlist is empty.</p>
                  <% } %>
                </div>
              </div>
            </div>
            <div class="ov-col">
              <!-- 6) Notifications / Alerts -->
              <div class="info-card">
                <div class="ic-head d-flex">
                  <h5 class="m-0">Notifications</h5>
                  <a href="/notifications" class="view-link">View all</a>
                </div>
                <div class="ic-body">
                  <% if (Array.isArray(notifications) && notifications.length) { %>
                    <ul class="list-clean">
                      <% notifications.forEach(n => { %>
                        <li class="lo-item" role="button" tabindex="0" <% if (n.link) { %>onclick="window.location.href='<%= n.link %>'"<% } %>>
                          <div class="lo-main">
                            <div class="lo-id"><%= n.title %></div>
                            <div class="lo-date"><%= new Date(n.created_at).toLocaleString() %></div>
                          </div>
                          <div class="lo-side">
                            <% if (!n.is_read) { %>
                              <span class="status-text processing">New</span>
                            <% } %>
                          </div>
                        </li>
                      <% }) %>
                    </ul>
                  <% } else if (typeof notice !== 'undefined' && notice) { %>
                    <div class="notif <%= notice.type === 'error' ? 'error' : 'ok' %>"><%= notice.message %></div>
                  <% } else { %>
                    <p class="empty">No new notifications.</p>
                  <% } %>
                </div>
              </div>

              <!-- 7) Saved Addresses -->
              <div class="info-card">
                <div class="ic-head d-flex">
                  <h5 class="m-0">Saved Addresses</h5>
                  <a href="#" class="view-link" onclick="event.preventDefault(); document.querySelector('[data-section=\'account\']').click();">Manage</a>
                </div>
                <div class="ic-body" id="overview-addresses">
                  <p class="empty">Loading addresses...</p>
                </div>
              </div>

              <!-- Announcements removed from account settings view -->
            </div>
          </section>
        </section>

        <!-- Profile Section -->
        <section class="section" id="account" aria-labelledby="profile-title">
          <div class="account-header">
            <div class="avatar-wrap">
              <img src="<%= user.profile_pic || user.profile_image || '/image/profile1.png' %>" alt="Profile picture" id="profilePreview2">
              <form action="/accountsettings/upload" method="POST" enctype="multipart/form-data" class="inline-form" style="margin-left:12px;">
                <label class="btn-secondary" for="profileInput2">
                  <i class="fa-solid fa-camera"></i> Change photo
                </label>
                <input type="file" name="profile_pic" id="profileInput2" accept="image/*" hidden>
                <button type="submit" class="btn-primary small" aria-label="Upload new profile photo">Upload</button>
              </form>
            </div>
            <div class="account-meta">
              <h3 id="profile-title">Profile & Security</h3>
              <p class="muted">Manage your personal info and password</p>
            </div>
          </div>

          <!-- Basic Info -->
          <div class="info-section">
            <h4>Basic Info</h4>
            <form action="/accountsettings/update-profile" method="POST" class="info-row" aria-label="Edit first name">
              <span>First name</span>
              <input type="text" name="first_name" value="<%= user.first_name || '' %>" readonly>
              <button type="submit" class="save-btn" style="display:none;">Save</button>
              <i class="fa-solid fa-pen edit-icon" aria-hidden="true" title="Edit"></i>
            </form>

            <form action="/accountsettings/update-profile" method="POST" class="info-row" aria-label="Edit last name">
              <span>Last name</span>
              <input type="text" name="last_name" value="<%= user.last_name || '' %>" readonly>
              <button type="submit" class="save-btn" style="display:none;">Save</button>
              <i class="fa-solid fa-pen edit-icon" aria-hidden="true" title="Edit"></i>
            </form>

            <form action="/accountsettings/update-email" method="POST" class="info-row" aria-label="Edit email">
              <span>Email</span>
              <input type="email" name="email" value="<%= user.email %>" readonly>
              <button type="submit" class="save-btn" style="display:none;">Save</button>
              <i class="fa-solid fa-pen edit-icon" aria-hidden="true" title="Edit"></i>
            </form>
          </div>

          <!-- Shipping Address -->
          <div class="info-section">
            <h4>Shipping Address</h4>
            <div id="addresses-list" class="addresses-container">
              <!-- Addresses will be loaded here -->
            </div>
            <button type="button" class="btn-primary" id="add-address-btn" style="margin-top: 12px;">
              <i class="fa-solid fa-plus"></i> Add New Address
            </button>
          </div>

          <!-- Security -->
          <div class="info-section">
            <h4>Security</h4>
            <!-- Collapsed row -->
            <div class="info-row" id="pw-collapsed" aria-label="Password settings summary">
              <span>Password</span>
              <span class="dots" aria-hidden="true">••••••••</span>
              <a href="#" class="view-link" id="pw-change-link"><%= user.has_password ? 'Change' : 'Set password' %></a>
            </div>
            <!-- Expanded form -->
            <form action="/accountsettings/update-password" method="POST" class="info-row hidden" id="pw-expanded" aria-label="Update password" data-require-current="<%= user.has_password ? 'true' : 'false' %>">
              <span>Password</span>
              <div class="pw-fields">
                <!-- Current/Old password -->
                <div class="pw-field">
                  <input id="curPw" type="password" name="current_password" placeholder="<%= user.has_password ? 'Current password' : 'Current password (not required if none)' %>" autocomplete="current-password" <%= user.has_password ? 'required' : '' %>>
                  <button type="button" class="pw-eye" data-target="curPw" aria-label="Toggle current password visibility"><i class="fa-regular fa-eye"></i></button>
                  <span id="curPwStatus" class="pw-status" aria-live="polite"></span>
                </div>

                <!-- New password -->
                <div class="pw-field">
                  <input id="newPw" type="password" name="new_password" placeholder="New password (min 12, A/a/1/! )" autocomplete="new-password" required>
                  <button type="button" class="pw-eye" data-target="newPw" aria-label="Toggle new password visibility"><i class="fa-regular fa-eye"></i></button>
                </div>

                <!-- Strength checklist -->
                <div class="pw-strength" aria-live="polite">
                  <p class="pw-guidance">Please add all necessary characters to create a safe password.</p>
                  <ul class="pw-reqs">
                    <li data-req="min">Minimum characters 12</li>
                    <li data-req="upper">One uppercase character</li>
                    <li data-req="lower">One lowercase character</li>
                    <li data-req="special">One special character</li>
                    <li data-req="number">One number</li>
                  </ul>
                </div>

                <!-- Confirm new password -->
                <div class="pw-field">
                  <input id="cfmPw" type="password" name="confirm_password" placeholder="Confirm new password" autocomplete="new-password" required>
                  <button type="button" class="pw-eye" data-target="cfmPw" aria-label="Toggle confirm password visibility"><i class="fa-regular fa-eye"></i></button>
                  <span id="cfmPwStatus" class="pw-status" aria-live="polite"></span>
                </div>

                <div class="pw-actions">
                  <button type="button" class="btn-outline small" id="pw-cancel">Cancel</button>
                  <button type="submit" class="save-btn" id="pw-save" disabled>Change Password</button>
                </div>
              </div>
            </form>
          </div>
        </section>

        <!-- Orders Section -->
        <section class="section" id="orders" aria-labelledby="orders-title">
          <h3 id="orders-title">My Orders</h3>
          <div class="orders-tabs" role="tablist" aria-label="Orders filters">
            <button type="button" class="orders-tab active" data-filter="ship" aria-selected="true"><i class="fa-solid fa-box"></i> To ship <span class="badge" id="cnt-ship">0</span></button>
            <button type="button" class="orders-tab" data-filter="receive" aria-selected="false"><i class="fa-solid fa-truck-fast"></i> To receive <span class="badge" id="cnt-receive">0</span></button>
            <button type="button" class="orders-tab" data-filter="review" aria-selected="false"><i class="fa-regular fa-star"></i> To review <span class="badge" id="cnt-review">0</span></button>
          </div>
          <div class="orders-cards">
            <% if (myOrders && myOrders.length) { %>
              <% myOrders.forEach(o => { %>
                <% 
                  const _s = (o.status || '').toLowerCase();
                  const isCancelled = !!o.cancelled_at || _s.includes('cancel');
                  const _group = isCancelled ? 'cancelled'
                                : ((_s.includes('deliver') || _s.includes('complete')) ? 'review'
                                : ((_s.includes('ship') || _s.includes('en route') || _s.includes('courier') || _s.includes('out')) ? 'receive' : 'ship'));
                  const d = o.order_date ? new Date(o.order_date) : new Date();
                  const start = new Date(d.getTime() + 2*24*60*60*1000);
                  const end = new Date(d.getTime() + 5*24*60*60*1000);
                  const fmt = (dt) => dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                  const first = (o.items && o.items[0]) || null;
                  const eta = o.estimated_delivery ? new Date(o.estimated_delivery) : null;
                  const etaStart = o.estimated_delivery_start ? new Date(o.estimated_delivery_start) : null;
                  const etaEnd = o.estimated_delivery_end ? new Date(o.estimated_delivery_end) : null;
                  let etaWindow = '';
                  if (etaStart && etaEnd){
                    if (etaStart.toDateString() === etaEnd.toDateString()) etaWindow = etaStart.toLocaleDateString();
                    else if (etaStart.getFullYear() === etaEnd.getFullYear() && etaStart.getMonth() === etaEnd.getMonth()) etaWindow = `${fmt(etaStart)} - ${etaEnd.getDate()}`;
                    else etaWindow = `${fmt(etaStart)} - ${fmt(etaEnd)}`;
                  } else if (etaStart || etaEnd){
                    etaWindow = (etaStart || etaEnd).toLocaleDateString();
                  } else if (eta){
                    etaWindow = eta.toLocaleDateString();
                  } else {
                    etaWindow = fmt(start) + ' - ' + fmt(end);
                  }
                %>
                <article class="order-card" data-group="<%= _group %>" data-id="<%= o.id %>" tabindex="0" role="button" aria-label="Open tracking for order #<%= o.id %>">
                  <header class="oc-head">
                    <div class="left">
                      <span class="shop-name">Order #<%= o.id %></span>
                    </div>
                    <div class="right">
                      <% const __sg = (o.status||'').toLowerCase();
                         const statusClass = (__sg.includes('deliver') || __sg.includes('complete')) ? 'done'
                                           : (__sg.includes('process') ? 'processing'
                                             : (/ship|en route|courier|out/.test(__sg) ? 'intransit' : ''));
                      %>
                      <span class="status-text <%= statusClass %>"><%= o.status || 'Pending' %></span>
                    </div>
                  </header>
                  <div class="oc-estimate">
                    <i class="fa-solid fa-truck-fast"></i>
                    <span>Estimated delivery :</span>
                    <strong class="est-window"><%= etaWindow %></strong>
                  </div>
                  <div class="oc-item">
                    <img class="item-thumb" src="<%= (first && first.image_url) || '/image/profile1.png' %>" alt="Product image">
                    <div class="item-main">
                      <h4 class="item-title"><%= (first && first.product_name) || 'Item' %></h4>
                      <div class="item-sub">x<%= (first && first.quantity) || 1 %></div>
                    </div>
                    <div class="item-price">$<%= (first && Number(first.price).toLocaleString()) || '0.00' %></div>
                  </div>
                  <% if (o.items && o.items.length > 1) { %>
                    <div class="oc-more">+<%= o.items.length - 1 %> more item<%= o.items.length - 1 > 1 ? 's' : '' %></div>
                  <% } %>
                  <footer class="oc-foot">
                    <div class="total">Total: <strong>$<%= Number(o.total_amount || 0).toLocaleString() %></strong></div>
                    <% 
                      const statusLower = (o.status || '').toLowerCase();
                      const isDelivered = statusLower.includes('deliver') || statusLower.includes('complete');
                      const firstProductId = o.items && o.items.length > 0 && o.items[0].product_id ? o.items[0].product_id : null;
                    %>
                    <% if (isDelivered) { %>
                      <% if (firstProductId) { %>
                        <button class="review-btn" onclick="event.stopPropagation(); window.location.href='/products/<%= firstProductId %>#reviews'">
                          <i class="fa-solid fa-star"></i> Write a Review
                        </button>
                      <% } else { %>
                        <button class="review-btn" onclick="event.stopPropagation(); alert('Product not found. Please contact support.')">
                          <i class="fa-solid fa-star"></i> Write a Review
                        </button>
                      <% } %>
                    <% } %>
                  </footer>
                </article>
              <% }) %>
            <% } else { %>
              <p class="empty">You have no orders yet.</p>
            <% } %>
          </div>
        </section>

        <!-- Wishlist Section -->
        <section class="section" id="wishlist" aria-labelledby="wishlist-title">
          <h3 id="wishlist-title">My Wishlist</h3>
          <div class="info-section">
            <% if (wishlistItems && wishlistItems.length > 0) { %>
              <% wishlistItems.forEach(item => { %>
                <div class="info-row wishlist-item" data-id="<%= item.wishlist_id %>" data-product-id="<%= item.product_id %>">
                  <img src="<%= item.image_url %>" alt="<%= item.product_name %>" class="wishlist-img" />
                  <div class="wishlist-details">
                    <h4><%= item.product_name %></h4>
                    <p>$<%= item.price %></p>
                  </div>
                  <div class="wishlist-actions">
                    <button type="button" class="btn-primary small add-to-cart-btn" data-product-id="<%= item.product_id %>">
                      <i class="fa-solid fa-cart-plus"></i> Add to Cart
                    </button>
                    <button type="button" class="remove-btn" data-id="<%= item.wishlist_id %>">
                      <i class="fa-solid fa-trash"></i> Remove
                    </button>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <p class="empty">Your wishlist is empty.</p>
            <% } %>
          </div>
        </section>

        <!-- Privacy Section -->
        <section class="section" id="privacy" aria-labelledby="privacy-title">
          <h3 id="privacy-title">Privacy Settings</h3>
          <div class="info-section">
            <div class="info-row"><span>Profile Visibility</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
            <div class="info-row"><span>Two-Factor Authentication</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
            <div class="info-row"><span>Blocked Accounts</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
          </div>
        </section>

        <!-- Languages Section -->
        <section class="section" id="languages" aria-labelledby="language-title">
          <h3 id="language-title">Language Settings</h3>
          <div class="info-section">
            <div class="info-row"><span>Preferred Language</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
            <div class="info-row"><span>Translation Options</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
          </div>
        </section>

        <!-- Help Section -->
        <section class="section" id="help" aria-labelledby="help-title">
          <h3 id="help-title">Help & Support</h3>
          <div class="info-section">
            <div class="info-row"><span>FAQs</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
            <div class="info-row"><span>Contact Support</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
            <div class="info-row"><span>Report a Problem</span> <a href="#" class="view-link"><i class="fa-solid fa-angle-right"></i></a></div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <footer>
    <%- include ("../partials/footer.ejs") %>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Sidebar navigation
      const menuItems = document.querySelectorAll('.sidebar ul li[data-section]');
      const sections = document.querySelectorAll('.section');

      function activateTab(sectionId){
        menuItems.forEach(i => i.classList.remove('active'));
        sections.forEach(sec => sec.classList.remove('active'));
        const menuItem = Array.from(menuItems).find(m => m.getAttribute('data-section') === sectionId);
        if(menuItem) menuItem.classList.add('active');
        const target = document.getElementById(sectionId);
        if(target) target.classList.add('active');
      }

      menuItems.forEach(item => {
        item.addEventListener('click', () => {
          const sectionId = item.getAttribute('data-section');
          if (sectionId) activateTab(sectionId);
        });
      });

      // Deep link via ?tab=orders
      const params = new URLSearchParams(window.location.search);
      const tab = params.get('tab') || 'general';
      activateTab(tab);

      // Edit rows toggle
      document.querySelectorAll('.edit-icon').forEach(icon => {
        icon.addEventListener('click', () => {
          const row = icon.closest('.info-row');
          const inputs = row.querySelectorAll('input');
          const saveBtn = row.querySelector('.save-btn');
          inputs.forEach(inp => inp.removeAttribute('readonly'));
          if (inputs[0]) inputs[0].focus();
          if (saveBtn) saveBtn.style.display = 'inline-block';
          icon.style.display = 'none';
        });
      });

      // Password: collapsed/expanded toggle
      const pwCollapsed = document.getElementById('pw-collapsed');
      const pwExpanded = document.getElementById('pw-expanded');
      const changeLink = document.getElementById('pw-change-link');
      const cancelBtn = document.getElementById('pw-cancel');
    // Eye toggles for each password field
      if (changeLink && pwCollapsed && pwExpanded) {
        changeLink.addEventListener('click', (e) => {
          e.preventDefault();
          pwCollapsed.classList.add('hidden');
          pwExpanded.classList.remove('hidden');
          const cur = pwExpanded.querySelector('input[name="current_password"]');
          if (cur) cur.focus();
        });
      }
      if (cancelBtn && pwCollapsed && pwExpanded) {
        cancelBtn.addEventListener('click', () => {
          // clear inputs
          pwExpanded.querySelectorAll('input[type="password"]').forEach(inp => inp.value = '');
          // reset visibility
          pwExpanded.querySelectorAll('input[name="current_password"], input[name="new_password"], input[name="confirm_password"]').forEach(inp => { inp.type = 'password'; });
          pwExpanded.classList.add('hidden');
          pwCollapsed.classList.remove('hidden');
        });
      }
      document.querySelectorAll('.pw-eye').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-target');
          const inp = document.getElementById(id);
          if (!inp) return;
          const showing = inp.type === 'text';
          inp.type = showing ? 'password' : 'text';
          const icon = btn.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-eye', showing);
            icon.classList.toggle('fa-eye-slash', !showing);
          }
        });
      });

      // Client-side min length validation for new password
      const pwForm = document.getElementById('pw-expanded');
      if (pwForm) {
        const curPw = document.getElementById('curPw');
        const newPw = document.getElementById('newPw');
        const cfmPw = document.getElementById('cfmPw');
        const curStatus = document.getElementById('curPwStatus');
        const cfmStatus = document.getElementById('cfmPwStatus');
        const saveBtn = document.getElementById('pw-save');

        function evalReqs(val){
          const reqs = {
            min: val.length >= 12,
            upper: /[A-Z]/.test(val),
            lower: /[a-z]/.test(val),
            number: /[0-9]/.test(val),
            special: /[^A-Za-z0-9]/.test(val)
          };
          document.querySelectorAll('.pw-reqs li').forEach(li => {
            const key = li.getAttribute('data-req');
            li.classList.toggle('met', !!reqs[key]);
          });
          return Object.values(reqs).every(Boolean);
        }

        function checkConfirm(){
          const match = newPw.value.trim() && (newPw.value.trim() === cfmPw.value.trim());
          cfmStatus.textContent = match ? 'Match' : (cfmPw.value ? 'Does not match' : '');
          cfmStatus.className = 'pw-status ' + (match ? 'ok' : (cfmPw.value ? 'err' : ''));
          return match;
        }

        function updateSave(){
          const strong = evalReqs(newPw.value.trim());
          const matched = checkConfirm();
          const requireCurrent = (pwForm.getAttribute('data-require-current') === 'true');
          const curOk = requireCurrent ? !!curPw.value.trim() : true;
          saveBtn.disabled = !(strong && matched && curOk);
        }

        ['input','keyup','change'].forEach(evt => {
          newPw.addEventListener(evt, updateSave);
          cfmPw.addEventListener(evt, updateSave);
          if (curPw) curPw.addEventListener(evt, () => {
            if (curPw.value.trim().length) {
              curStatus.textContent = '';
              curStatus.className = 'pw-status';
            }
            updateSave();
          });
        });

        pwForm.addEventListener('submit', (e) => {
          const strong = evalReqs(newPw.value.trim());
          const matched = checkConfirm();
          if (!strong || !matched) {
            e.preventDefault();
          }
        });
      }

  // Profile image preview (both instances)
  const fileInputs = [document.getElementById('profileInput'), document.getElementById('profileInput2')].filter(Boolean);
      const previews = [document.getElementById('profilePreview'), document.getElementById('profilePreview2')].filter(Boolean);
      fileInputs.forEach(input => {
        input.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (file) {
            const url = URL.createObjectURL(file);
            previews.forEach(p => p && (p.src = url));
          }
        });
      });

      // Wishlist remove (event delegation for robustness)
      const wishlistSection = document.getElementById('wishlist');
      if (wishlistSection) {
        wishlistSection.addEventListener('click', async (e) => {
          // Handle remove button
          const removeBtn = e.target.closest('.remove-btn');
          if (removeBtn) {
            const wishlistId = removeBtn.getAttribute('data-id');
            try {
              const res = await fetch(`/accountsettings/wishlist/remove/${wishlistId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
              if (res.ok) {
                const itemRow = removeBtn.closest('.wishlist-item');
                if (itemRow) itemRow.remove();
                const remaining = document.querySelectorAll('.wishlist-item');
                if (remaining.length === 0) {
                  const container = document.querySelector('#wishlist .info-section');
                  if (container) container.innerHTML = '<p class="empty">Your wishlist is empty.</p>';
                }
              } else {
                alert('Failed to remove item.');
              }
            } catch (err) {
              console.error('Error:', err);
              alert('Error removing item.');
            }
            return;
          }

          // Handle add to cart button
          const addToCartBtn = e.target.closest('.add-to-cart-btn');
          if (addToCartBtn) {
            const productId = addToCartBtn.getAttribute('data-product-id');
            const originalText = addToCartBtn.innerHTML;
            
            try {
              addToCartBtn.disabled = true;
              addToCartBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding...';
              
              const res = await fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  product_id: parseInt(productId), 
                  quantity: 1 
                })
              });
              
              const data = await res.json().catch(() => ({}));
              
              if (!res.ok) {
                // Handle specific error cases
                if (data.error === 'Size is required for this color' || data.error === 'Color is required for this size') {
                  throw new Error('This product requires size and color selection. Please visit the product page to add it to cart.');
                }
                if (data.error === 'Not enough stock for selected size') {
                  throw new Error(`Only ${data.available || 0} item(s) available in stock.`);
                }
                throw new Error(data.message || data.error || 'Failed to add to cart');
              }
              
              if (data.ok || data.success) {
                addToCartBtn.innerHTML = '<i class="fa-solid fa-check"></i> Added!';
                setTimeout(() => {
                  addToCartBtn.innerHTML = originalText;
                  addToCartBtn.disabled = false;
                }, 2000);
              } else {
                throw new Error(data.message || data.error || 'Failed to add item to cart');
              }
            } catch (err) {
              console.error('Error adding to cart:', err);
              alert(err.message || 'Error adding item to cart.');
              addToCartBtn.innerHTML = originalText;
              addToCartBtn.disabled = false;
            }
            return;
          }
        });
      }

      // Orders tabs + card filtering
      const tabs = Array.from(document.querySelectorAll('.orders-tab'));
      const cards = Array.from(document.querySelectorAll('.order-card'));
      function updateCounts(){
        const counts = { ship: 0, receive: 0, review: 0 };
        cards.forEach(c => { const g = c.getAttribute('data-group'); if (counts[g] != null) counts[g]++; });
        const ship = document.getElementById('cnt-ship'); if (ship) ship.textContent = counts.ship;
        const rec = document.getElementById('cnt-receive'); if (rec) rec.textContent = counts.receive;
        const rev = document.getElementById('cnt-review'); if (rev) rev.textContent = counts.review;
      }
      function applyFilter(key){
        tabs.forEach(t => { const on = t.getAttribute('data-filter') === key; t.classList.toggle('active', on); t.setAttribute('aria-selected', on ? 'true' : 'false'); });
        cards.forEach(c => { const match = c.getAttribute('data-group') === key; c.style.display = match ? '' : 'none'; });
      }
      async function cancelOrder(orderId, btn){
        try{
          btn.disabled = true; btn.textContent = 'Cancelling...';
          const res = await fetch(`/accountsettings/orders/${orderId}/cancel`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
          if(!res.ok){ throw new Error('Failed'); }
          const card = document.querySelector(`.order-card[data-id="${orderId}"]`);
          if(card){ card.remove(); }
          updateCounts();
        }catch(e){
          alert('Unable to cancel this order now.');
        }finally{
          if(btn){ btn.disabled = false; btn.textContent = 'Cancel order'; }
        }
      }
      if (tabs.length){
        updateCounts();
        applyFilter('ship');
        tabs.forEach(t => t.addEventListener('click', () => applyFilter(t.getAttribute('data-filter'))));
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('.btn-cancel');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          if(confirm('Cancel this order?')) cancelOrder(id, btn);
        });
        // Navigate to tracking when clicking on a card (except on cancel button)
        document.addEventListener('click', (e) => {
          const card = e.target.closest('.order-card');
          if(!card) return;
          const cancel = e.target.closest('.btn-cancel');
          if (cancel) return; // let cancel handler run
          const id = card.getAttribute('data-id');
          window.location.href = `/orders/${id}/track`;
        });
        // Keyboard accessibility
        document.addEventListener('keydown', (e) => {
          const card = e.target.closest('.order-card');
          if (!card) return;
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const id = card.getAttribute('data-id');
            window.location.href = `/orders/${id}/track`;
          }
        });
      }

      // ==============================
      // SHIPPING ADDRESSES MANAGEMENT
      // ==============================
      async function loadAddresses() {
        try {
          const res = await fetch('/api/addresses');
          const data = await res.json();
          if (data.success) {
            displayAddresses(data.addresses);
          }
        } catch (err) {
          console.error('Error loading addresses:', err);
        }
      }

      function displayAddresses(addresses) {
        const container = document.getElementById('addresses-list');
        if (!container) {
          console.warn('addresses-list container not found');
          return;
        }
        if (!addresses || addresses.length === 0) {
          container.innerHTML = '<p class="empty">No saved addresses yet.</p>';
          return;
        }

        container.innerHTML = addresses.map(addr => `
          <div class="address-card" data-id="${addr.id}">
            <div class="address-content">
              <div class="address-header">
                <h5 class="address-label">${addr.label || 'Address'}</h5>
                ${addr.is_default ? '<span class="default-badge">Default</span>' : ''}
              </div>
              <div class="address-body">
                <p class="address-name">${addr.first_name || ''} ${addr.last_name || ''}</p>
                <p class="address-line">${addr.address_line || ''}</p>
                <p class="address-city">${addr.city || ''}, ${addr.province || ''} ${addr.zipcode || ''}</p>
                <p class="address-contact">${addr.phone || ''} ${addr.email ? '• ' + addr.email : ''}</p>
              </div>
            </div>
            <div class="address-actions">
              ${!addr.is_default ? '<button type="button" class="btn-outline small set-default-btn" data-id="' + addr.id + '">Set as Default</button>' : ''}
              <button type="button" class="btn-outline small danger delete-address-btn" data-id="${addr.id}">
                <i class="fa-solid fa-trash"></i> Delete
              </button>
            </div>
          </div>
        `).join('');

        // Attach event listeners
        container.querySelectorAll('.set-default-btn').forEach(btn => {
          btn.addEventListener('click', () => setDefaultAddress(btn.getAttribute('data-id')));
        });
        container.querySelectorAll('.delete-address-btn').forEach(btn => {
          btn.addEventListener('click', () => deleteAddress(btn.getAttribute('data-id')));
        });
      }

      async function setDefaultAddress(id) {
        try {
          const res = await fetch(`/api/addresses/${id}/default`, { method: 'PUT' });
          const data = await res.json();
          if (data.success) {
            loadAddresses();
          }
        } catch (err) {
          console.error('Error setting default address:', err);
          alert('Failed to set default address');
        }
      }

      async function deleteAddress(id) {
        if (!confirm('Are you sure you want to delete this address?')) return;
        try {
          const res = await fetch(`/api/addresses/${id}`, { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            loadAddresses();
          }
        } catch (err) {
          console.error('Error deleting address:', err);
          alert('Failed to delete address');
        }
      }

      function showAddAddressForm() {
        const form = document.createElement('div');
        form.className = 'address-form-overlay';
        form.innerHTML = `
          <div class="address-form-modal">
            <div class="address-form-header">
              <h4>Add New Address</h4>
              <button type="button" class="close-btn" id="close-address-form">&times;</button>
            </div>
            <form id="new-address-form">
              <div class="form-grid">
                <div class="form-group">
                  <label>Label (e.g., Home, Office)</label>
                  <input type="text" name="label" placeholder="Home" />
                </div>
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" name="first_name" required />
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" name="last_name" required />
                </div>
                <div class="form-group">
                  <label>Phone *</label>
                  <input type="tel" name="phone" required />
                </div>
                <div class="form-group full-width">
                  <label>Email</label>
                  <input type="email" name="email" />
                </div>
                <div class="form-group full-width">
                  <label>Address Line *</label>
                  <input type="text" name="address_line" placeholder="Street address" required />
                </div>
                <div class="form-group">
                  <label>City *</label>
                  <input type="text" name="city" required />
                </div>
                <div class="form-group">
                  <label>Province/State *</label>
                  <input type="text" name="province" required />
                </div>
                <div class="form-group">
                  <label>Zip Code *</label>
                  <input type="text" name="zipcode" required />
                </div>
                <div class="form-group full-width">
                  <label class="checkbox-label">
                    <input type="checkbox" name="is_default" />
                    Set as default address
                  </label>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn-outline" id="cancel-address-form">Cancel</button>
                <button type="submit" class="btn-primary">Save Address</button>
              </div>
            </form>
          </div>
        `;
        document.body.appendChild(form);

        document.getElementById('close-address-form').addEventListener('click', () => form.remove());
        document.getElementById('cancel-address-form').addEventListener('click', () => form.remove());
        
        document.getElementById('new-address-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);
          data.is_default = formData.has('is_default');

          try {
            const res = await fetch('/api/addresses', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
              form.remove();
              loadAddresses();
            } else {
              alert('Failed to save address');
            }
          } catch (err) {
            console.error('Error saving address:', err);
            alert('Failed to save address');
          }
        });
      }

      const addAddressBtn = document.getElementById('add-address-btn');
      if (addAddressBtn) {
        addAddressBtn.addEventListener('click', showAddAddressForm);
      }

      // Load addresses on page load
      loadAddresses();

      // ==============================
      // OVERVIEW: Display saved addresses
      // ==============================
      async function loadOverviewAddresses() {
        const overviewContainer = document.getElementById('overview-addresses');
        if (!overviewContainer) return;

        try {
          const res = await fetch('/api/addresses');
          const data = await res.json();
          
          if (data.success && data.addresses && data.addresses.length > 0) {
            const addresses = data.addresses.slice(0, 3); // Show only top 3
            overviewContainer.innerHTML = `
              <ul class="list-clean">
                ${addresses.map(addr => `
                  <li class="addr-item">
                    <div class="addr-main">
                      <div class="addr-label">
                        ${addr.label || 'Address'}
                        ${addr.is_default ? '<span class="default-mini">Default</span>' : ''}
                      </div>
                      <div class="addr-details">${addr.address_line || ''}, ${addr.city || ''}</div>
                    </div>
                  </li>
                `).join('')}
              </ul>
              ${data.addresses.length > 3 ? `<p class="addr-more">+${data.addresses.length - 3} more address${data.addresses.length - 3 > 1 ? 'es' : ''}</p>` : ''}
            `;
          } else {
            overviewContainer.innerHTML = '<p class="empty">No saved addresses yet.</p>';
          }
        } catch (err) {
          console.error('Error loading overview addresses:', err);
          overviewContainer.innerHTML = '<p class="empty">Failed to load addresses.</p>';
        }
      }

      // Load overview addresses on page load
      loadOverviewAddresses();
    });
  </script>

  <style>
    .status-chip{display:inline-block;padding:4px 10px;border-radius:16px;font-size:12px}
    .status-chip.pending{background:#FEF9C3;color:#A16207}
    .status-chip.done{background:#DCFCE7;color:#166534}
    .view-link{color:#2563EB;text-decoration:none}
    .view-link:hover{text-decoration:underline}
    .toggle-label{font-size:12px;color:#6b7280;display:flex;align-items:center;gap:6px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff;margin-top:12px}
    .card-head h4{margin:0 0 4px}
    .card-head .small{font-size:12px}

    /* Orders tabs */
  .orders-tabs{display:flex;gap:8px;margin:10px 0 12px; justify-content:center}
  .orders-tab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:8px}
  .orders-tab i{opacity:.85}
  .orders-cards{display:flex;flex-direction:column;gap:12px}
  .order-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;cursor:pointer;transition:box-shadow .15s ease, transform .05s}
  .order-card:focus{outline:2px solid #2563eb; outline-offset:2px}
  .order-card:hover{box-shadow:0 6px 18px rgba(2,6,23,0.08)}
  .oc-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #f1f5f9}
  .oc-head .left{display:flex;align-items:center;gap:8px}
  .mall-badge{background:#0f172a;color:#fff;border-radius:6px;padding:2px 6px;font-size:12px;font-weight:700}
  .shop-name{font-weight:700}
  .status-text{font-weight:600;color:#334155}
  .status-text.done{color:#16a34a}
  .status-text.intransit{color:#2563eb}
  .status-text.processing{color:#d97706}
  .oc-estimate{display:flex;align-items:center;gap:8px;padding:12px 14px;border-bottom:1px dashed #e5e7eb;color:#475569}
  .oc-estimate i{color:#334155}
  .oc-estimate .est-window{color:#0ea5e9}
  .oc-item{display:flex;align-items:center;gap:12px;padding:12px 14px}
  .item-thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;border:1px solid #e5e7eb}
  .item-main{flex:1}
  .item-title{font-size:14px;margin:0 0 4px}
  .item-sub{font-size:12px;color:#6b7280}
  .item-price{font-weight:700}
  .oc-more{padding:0 14px 8px;color:#64748b;font-size:12px}
  .oc-foot{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid #f1f5f9}
  .oc-foot .total{color:#334155}
  .oc-foot .actions{display:flex;gap:8px}
  .btn-outline{border:1px solid #e5e7eb;background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  .btn-outline.danger{border-color:#fecaca;color:#b91c1c}
  .btn-outline.small{font-size:12px}
    .orders-tab .badge{background:#e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;font-weight:700}
    .orders-tab.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .orders-tab.active .badge{background:rgba(255,255,255,0.25);color:#fff}

  /* Shipping Addresses */
  .addresses-container{display:flex;flex-direction:column;gap:12px;margin-top:12px}
  .address-card{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:flex-start;gap:16px}
  .address-content{flex:1}
  .address-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .address-label{margin:0;font-size:16px;font-weight:700;color:#0f172a}
  .default-badge{background:#dcfce7;color:#166534;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600}
  .address-body{color:#475569}
  .address-body p{margin:4px 0}
  .address-name{font-weight:600;color:#0f172a}
  .address-line,.address-city,.address-contact{font-size:14px}
  .address-actions{display:flex;flex-direction:column;gap:8px}

  /* Address Form Modal */
  .address-form-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999}
  .address-form-modal{background:#fff;border-radius:16px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)}
  .address-form-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid #e5e7eb}
  .address-form-header h4{margin:0;font-size:20px;font-weight:700}
  .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#6b7280;line-height:1;padding:0}
  .close-btn:hover{color:#0f172a}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:20px}
  .form-group{display:flex;flex-direction:column}
  .form-group.full-width{grid-column:1 / -1}
  .form-group label{font-weight:600;margin-bottom:6px;color:#334155;font-size:14px}
  .form-group input{padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
  .form-group input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
  .checkbox-label{display:flex;align-items:center;gap:8px;cursor:pointer}
  .checkbox-label input[type="checkbox"]{width:auto;margin:0}
  .form-actions{display:flex;justify-content:flex-end;gap:12px;padding:16px 20px;border-top:1px solid #e5e7eb}

  /* Overview Addresses */
  .addr-item{display:flex;align-items:flex-start;padding:10px 0;border-bottom:1px solid #f8fafc}
  .addr-item:last-child{border-bottom:none}
  .addr-main{flex:1}
  .addr-label{font-weight:700;font-size:14px;color:#0f172a;display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .default-mini{background:#dcfce7;color:#166534;padding:1px 6px;border-radius:8px;font-size:11px;font-weight:600}
  .addr-details{font-size:13px;color:#64748b}
  .addr-more{margin-top:8px;font-size:13px;color:#64748b;font-style:italic}

  /* Dashboard summary (removed) */

    /* Overview widgets */
    .overview-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-top:12px}
    @media (max-width: 1000px){ .overview-grid{grid-template-columns:1fr;} }
    .info-card{border:1px solid #e5e7eb;background:#fff;border-radius:12px;margin-bottom:12px}
    .info-card .ic-head{padding:12px 14px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;justify-content:space-between}
    .info-card .ic-body{padding:12px 14px}
    .info-card .ic-foot{padding:10px 14px;border-top:1px solid #f1f5f9}
    .ic-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
    .ic-label{color:#6b7280;font-size:13px}
    .ic-value{font-weight:600}
    .list-clean{list-style:none;margin:0;padding:0}
    .lo-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f8fafc;cursor:pointer}
    .lo-item:last-child{border-bottom:none}
    .lo-main{display:flex;flex-direction:column}
    .lo-id{font-weight:700}
    .lo-date{color:#64748b;font-size:12px}
    .lo-side{text-align:right}
    .lo-total{font-weight:800}
    .wl-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f8fafc}
    .wl-item:last-child{border-bottom:none}
    .wl-thumb{width:44px;height:44px;border-radius:8px;object-fit:cover;border:1px solid #e5e7eb}
    .wl-name{font-weight:600}
    .wl-price{color:#0f172a;font-weight:700}
    .list-bullet{margin:0;padding-left:18px}
    .notif{padding:10px;border-radius:8px}
    .notif.ok{background:#ecfdf5;color:#065f46}
    .notif.error{background:#fef2f2;color:#991b1b}
  </style>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
          <h5 class="modal-title" id="reviewModalLabel">
            <i class="fa-solid fa-star"></i> Write a Review
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Order #<span id="reviewOrderId"></span></label>
            <div id="reviewOrderItems" class="mb-3"></div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Your Rating <span class="text-danger">*</span></label>
            <div class="star-rating">
              <i class="fa-star fa-regular star-input" data-rating="1"></i>
              <i class="fa-star fa-regular star-input" data-rating="2"></i>
              <i class="fa-star fa-regular star-input" data-rating="3"></i>
              <i class="fa-star fa-regular star-input" data-rating="4"></i>
              <i class="fa-star fa-regular star-input" data-rating="5"></i>
            </div>
            <input type="hidden" id="reviewRating" value="0">
          </div>

          <div class="mb-3">
            <label for="reviewComment" class="form-label fw-bold">Your Review <span class="text-danger">*</span></label>
            <textarea class="form-control" id="reviewComment" rows="4" placeholder="Share your experience with this product..."></textarea>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle-fill"></i> Your review helps other customers make informed decisions!
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="submitReview()" style="background: #f59e0b; border-color: #f59e0b;">
            <i class="fa-solid fa-paper-plane"></i> Submit Review
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .star-rating {
      display: flex;
      gap: 10px;
      font-size: 32px;
      cursor: pointer;
    }
    .star-input {
      color: #d1d5db;
      transition: all 0.2s;
    }
    .star-input:hover,
    .star-input.active {
      color: #f59e0b;
    }
    .star-input.fa-solid {
      color: #f59e0b;
    }
  </style>

  <script>
    let reviewModal = null;
    let currentOrderId = null;

    // Write a Review Modal Function
    function openReviewModal(button) {
      currentOrderId = button.getAttribute('data-order-id');
      document.getElementById('reviewOrderId').textContent = currentOrderId;
      
      // Reset form
      document.getElementById('reviewRating').value = '0';
      document.getElementById('reviewComment').value = '';
      resetStars();
      
      // Load order items
      loadOrderItems(currentOrderId);
      
      // Show modal
      if (!reviewModal) {
        reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));
      }
      reviewModal.show();
    }

    async function loadOrderItems(orderId) {
      try {
        const response = await fetch(`/orders/${orderId}/items`);
        const data = await response.json();
        
        if (data.success && data.items) {
          const itemsHtml = data.items.map(item => `
            <div class="d-flex align-items-center gap-2 mb-2">
              <img src="${item.image_url || '/image/placeholder.png'}" 
                   alt="${item.product_name}" 
                   style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">
              <div>
                <div class="fw-bold">${item.product_name}</div>
                <small class="text-muted">Qty: ${item.quantity}</small>
              </div>
            </div>
          `).join('');
          document.getElementById('reviewOrderItems').innerHTML = itemsHtml;
        }
      } catch (error) {
        console.error('Error loading order items:', error);
        document.getElementById('reviewOrderItems').innerHTML = '<p class="text-muted">Order items</p>';
      }
    }

    // Star rating functionality
    document.addEventListener('DOMContentLoaded', function() {
      const stars = document.querySelectorAll('.star-input');
      
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          document.getElementById('reviewRating').value = rating;
          
          // Update star display
          stars.forEach(s => {
            const starRating = parseInt(s.getAttribute('data-rating'));
            if (starRating <= rating) {
              s.classList.remove('fa-regular');
              s.classList.add('fa-solid', 'active');
            } else {
              s.classList.remove('fa-solid', 'active');
              s.classList.add('fa-regular');
            }
          });
        });

        star.addEventListener('mouseenter', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          stars.forEach(s => {
            const starRating = parseInt(s.getAttribute('data-rating'));
            if (starRating <= rating) {
              s.classList.add('active');
            }
          });
        });
      });

      const starContainer = document.querySelector('.star-rating');
      if (starContainer) {
        starContainer.addEventListener('mouseleave', function() {
          const currentRating = parseInt(document.getElementById('reviewRating').value);
          stars.forEach(s => {
            const starRating = parseInt(s.getAttribute('data-rating'));
            if (starRating > currentRating) {
              s.classList.remove('active');
            }
          });
        });
      }
    });

    function resetStars() {
      const stars = document.querySelectorAll('.star-input');
      stars.forEach(s => {
        s.classList.remove('fa-solid', 'active');
        s.classList.add('fa-regular');
      });
    }

    async function submitReview() {
      const rating = parseInt(document.getElementById('reviewRating').value);
      const comment = document.getElementById('reviewComment').value.trim();

      // Validation
      if (rating === 0) {
        alert('Please select a rating');
        return;
      }

      if (!comment) {
        alert('Please write a review');
        return;
      }

      if (comment.length < 10) {
        alert('Review must be at least 10 characters long');
        return;
      }

      const submitBtn = event.target;
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

      try {
        const response = await fetch(`/orders/${currentOrderId}/review`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            rating: rating,
            comment: comment
          })
        });

        const data = await response.json();

        if (data.success) {
          // Close modal
          if (reviewModal) reviewModal.hide();
          
          // Show success message
          alert('✅ Thank you for your review!');
          
          // Reload page to update order status
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          alert(data.error || 'Failed to submit review');
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      } catch (error) {
        console.error('Error submitting review:', error);
        alert('Failed to submit review. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }
  </script>
</body>
</html>
