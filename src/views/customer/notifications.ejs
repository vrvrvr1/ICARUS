<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notifications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/global.css">
</head>
<body>
  <%- include ("../partials/header.ejs") %>

  <main class="container py-4">
    <h1 class="h4 mb-3">Notifications</h1>

    <% if (items && items.length) { %>
      <ul class="list-group shadow-sm">
        <% items.forEach(n => { %>
          <li class="list-group-item d-flex justify-content-between align-items-start <%= n.is_read ? '' : 'list-group-item-warning' %>">
            <div class="ms-2 me-auto">
              <div class="fw-semibold"><%= n.title %></div>
              <% if (n.body) { %><div class="text-muted small"><%= n.body %></div><% } %>
              <div class="small text-secondary"><%= new Date(n.created_at).toLocaleString() %></div>
            </div>
            <% if (n.link) { %>
              <a class="btn btn-sm btn-outline-primary" href="<%= n.link %>">View</a>
            <% } %>
          </li>
        <% }) %>
      </ul>
      <div class="mt-3">
        <button id="markAllRead" class="btn btn-sm btn-secondary">Mark all as read</button>
      </div>
    <% } else { %>
      <div class="alert alert-light border">No notifications yet.</div>
    <% } %>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const btn = document.getElementById('markAllRead');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          const res = await fetch('/notifications/mark-read', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
          if (res.ok) {
            // update badge and refresh
            if (window.updateNotifCount) window.updateNotifCount();
            try { localStorage.setItem('notif-tick', String(Date.now())); } catch(_) {}
            location.reload();
          }
        } catch(_){ }
      });
    })();
  </script>
</body>
</html>
